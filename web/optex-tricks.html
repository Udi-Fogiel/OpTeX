<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<HTML><HEAD>
<META HTTP-Equiv="Content-Type" CONTENT="text/html; charset=utf8">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">

<TITLE>OpTeX - tricks, tips</TITLE>

<style type="text/css">
<!--
 .lmarg {margin-left: -200px; margin-top: -15px;
        width: 200px; height: 0px;
        font-weight: bold;
        text-align: right;
        position: relative; top: 15px; left: -15px; 
        overflow; }
 .rmarg {margin-left: 13px; margin-top: -15px;
        width: 200px; height: 0px;
        text-align: left;
        position: relative; top: 15px; right: -600px; 
        overflow; }
  .datum {text-align: right; margin-bottom: -10px; font-size: 80%}
  p   { text-align: justify }
  pre { width: 600px; overflow; }  
-->
</style>

</HEAD>
<BODY bgcolor="#FFFFFF">

<table width="600" border="0" cellspacing="0" cellpadding="0"
align="center">
<tr><td>
  <div STYLE="text-align: center">
  <a href="http://petr.olsak.net/optex"><IMG SRC="../img/optex-logo.jpg" ALT="OpTeX" border=0></a>
  </div>


<h1 STYLE="text-align: center">OpTeX - tips, tricks, howto</h1>


<p>This page includes solutions of various tasks when 
<a href="http://petr.olsak.net/optex/">OpTeX</a> is used.
Each solution would be ``small'', it means you can see whole solution at
once in your www browser. The constellation of each solution is similar: user
description followed by macro code followed by explanation of the macro
code. User can copy and paste the macro code to his/her document simply by
the mouse.

<p>If there exists any tip from you, OpTeX user, don't hesitate please and send
me it. I'll welcome it and save it here (with the author of the solution
mentioned).

<p><a href="http://petr.olsak.net/opmac-tricks-e.html">OPmac tricks</a> 
can be used too but re-implementation of the code is probably
needed because OPmac uses different internal macros than OpTeX.
The important OPmac tricks will be re-implemented here soon.

<p>Note that several OPmac tricks are implemented directly into OpTeX:

<ul>
<li> \colordef does colors mixing.
<li> \morecolors reads color names from xcolor package.
<li> Footnotes has their own color stack.
<li> \transformbox applies linear transformations.
<li> \oval, \circle create colored oval or circle around text.
<li> \clipinoval, \clipincircle declare clipping path for images.
<li> \hisyntax performs syntax highlighting for C, Python, TeX, 
     html and XML languages.
<li> \draft and \showlabels can be used for printing labels in draft mode.
<li> \lipsum prints the text Lorem ipsum dolor sit.
<li> \mathbox creates a \hbox in math list with size-context.
<li> \numberedpar helps with creating numbered Theorems, Definitions etc.
<li> \inspic syntax allows alternative \inspic{filename.ext} without
     space separator.
<li> \inkinspic inludes pictures with labels generated by Inkscape.
<li> \crlp is implemented for tables.
<li> Tables to given width.
<li> Variations of paragraphs with p declarator.
<li> Vertical centered text in more rows in tables. 
<lI> Eqbox: equal width of boxes acros whole document.
<li> \slides style allows to create presentations.
<li> \usebib reads directly .bib databases without any external program.
<li> Index allows hyperlinked pages and alternative page lists.
</ul>

<hr>

<h2>Contents</h2>

<ul>
<li>Fonts
<ul>
    <li><a href="#scaleto">Text size changed to the desired width</a>
    <li><a href="#fawesome">More than 1300 icons from Awesome5 fonts</a>
    <li><a href="#nonunicode">Fons with non-Unicode encoding</a>
</ul>

<li>Verbatim
<ul>
    <li><a href="#inttinoval">Code blocks like in Markdown</a>
    <li><a href="#keepverb">Inline verbatim in macro parameters</a>
</ul>

<li>Math
<ul>
    <li><a href="#bbchar">\bbchar from AMS fonts when Unicode math font is used</a>
    <li><a href="#matrixx">More comfortable writing of matrices</a>
</ul>

<li>Tables
<ul>
    <li><a href="#colortab">Colored cells in the table</a>
    <li><a href="#colorlin">Colored lines in the table</a>
    <li><a href="#booktabs">Tables like in booktabs package</a>
    <li><a href="#decdigits">Decimal digits aligned by the decimal point</a>
    <li><a href="#longtable">Long table across multiple pages</a>
</ul>

<li>Macro tricks
<ul>
    <li><a href="#keyval">The options in key=value dictionaries</a>
    <li><a href="#condi">Structured conditionals</a>
    <li><a href="#setpos">Absolute positions on the page<a>
    <li><a href="#tabs">Tabbing macros</a>
</ul>

<li>Others
<ul>
    <li><a href="#diff">Showing differences between versions of the document</a>
    <li><a href="#overleaf">How to run OpTeX at Overleaf</a>
</ul>


</ul>
<br><hr>

<p CLASS="lmarg">Fonts</p>

<h2><a name="scaleto"></a>Text size changed to the desired width</h2>

<p>We prepare the macro \scaleto size {text} which prints “text” by actual font rescaled, 
that the “text” width is the given size.

<pre>
\def\scaleto#1#{\def\tmp{#1}\scaletoA}
\def\scaletoA#1{\setbox0=\hbox{{#1}}%
   \edef\tmp{\expr{\bp{\tmp}/\bp{\wd0}}}%
   \transformbox{\pdfscale{\tmp}{\tmp}}{#1}}

\scaleto 7cm {text} % the "text" has 7cm width 
</pre>

<p>The desired dimension is saved to the \tmp macro and \scaletoA does the real work. It 
saves the text to \hbox 0 and calculate the coefficient of scaling as \tmp/\wd0.
This coefficient is saved to \tmp again and used in the \transformbox{\pdfscale}{} macro.

<p>You can compare the solution of similar task in OPmac trick 027. 
You can see that we have more powerful tools for calculation than in OPmac: 
\bp converts the dimension to Adobe points and \expr calculates the ratio.

<p>If you are using a font family with optical sizes, then we need to scale
to right optical size. Then we can use \scaletof size {text}.

<pre>
\def\scaletof#1#{\def\tmp{#1}\scaletofA}
\def\scaletofA#1{\setbox0=\hbox{{#1}}%
   \edef\tmpa{\expr{\bp{\tmp}/\bp{\wd0}}}%
   \scaletoA{\setfontsize{mag\tmpa}\currvar#1}}
</pre>

<p>The \setfontsize{mag factor} is calculated, where the factor is the
scale ratio calculated and saved in the \tmpa. 
When the font is changed then the result is not exactly 
the desired width, because new font have a little different proportions. 
So previous \scaletoA is called again to reach the exact accuracy.

<p CLASS=datum>(0011) -- P. O. 2020-05-06<p>
<hr>

<h2><a name="fawesome"></a>More than 1300 icons from Awesome5 fonts</h2>

<p>The TeX distribitions include OTF fonts FontAwesome5Free-Solid-900,
FontAwesome5Brands-Regular-400 and FontAwesome5Free-Regular-400
with icons (dingbats) like keyboard, house, faces etc. See the
<a href="http://mirrors.ctan.org/fonts/fontawesome5/doc/fontawesome5.pdf">documentation 
   from fontawesome5 LaTeX package</a> 
where all these dingbats are listed. 
We want to use them. The following macro code does it:

<pre>
\initunifonts  % we need to load OTF fonts
\font\tenfafree      =[FontAwesome5Free-Solid-900]
\font\tenfabran      =[FontAwesome5Brands-Regular-400]
\font\tenfafreeregul =[FontAwesome5Free-Regular-400]
\protected\def\faregul#1{{\let\tenfafree=\tenfafreeregul #1}}
\protected\def\fafree{\tenfafree\resizethefont}
\protected\def\fabran{\tenfabran\resizethefont}
\def\__fontawesome_def_icon:nnnnn#1#2#3#4#5{%
   \ifx^#1^\else
      \getfourtokens\tmp#3\relax 
      \protected\edef#1{{\csname fa\tmp\endcsname \char#5}}%
   \fi
}
\def\getfourtokens#1#2#3#4#5#6\relax{\def#1{#2#3#4#5}}
\input fontawesome5-mapping.def
\__fontawesome_def_icon:nnnnn{\faWifi}{wifi}{free3}{213}{"F1EB}
</pre> 

<p>Now, you can use all control sequences listed in the fontawesome5
documentation. For example \faHouseUser, \faAngry, \faApple, etc. 
The alternative syntax like \faIcon{Angry} is not supported.
A few icons are in its "regular" variants. They are listed as 
\faAngry[regular] in the fontawesone5 documentation. 
These icons are available by the \faregul prefix in uour macro, 
i.e. \faregul\faAngry.

<p><b>Notice to the implementation</b>. The three fonts with dingbats are
loaded as \tenfafree, \tenfabran and \tenfafreeregul. The third one includes
the "regular" variants. The macros \fafree amd \fabran select these fonts
at current size used by Font Selection System from OpTeX.

<p>We need to read the mapping from names to the font codes. It is saved in
the fontawesome5-mapping.def. The set of \__fontawesome_def macros
are used here. We define such macro in order to read this mapping and then
we do \input fontawesome5-mapping.def.

<p>Of course, if Marcel Krüger make changes in the fontawesome5-mapping.def
file syntax, we must to redeclare our macros. I hope that this syntax is
more or less stable.

<p>You can compare the complexity of macros in the LaTeX implemenation with
these 16 lines of plain TeX macros. Only TeX primitives are used here (and
two OpTeX macros \initunifonts and \resizethefont). This is one of reasons
why I like plain TeX.

<p CLASS=datum>(0012) -- P. O. 2020-05-08<p>
<hr>

<h2><a name="nonunicode"></a>Fonts with non-Unicode encoding</h2>

<p>OpTeX does not prefer such fonts but sometimes there are a reason to use
them. For example the font
<a href="http://petr.olsak.net/ftp/olsak/slabikar/slabi.pdf">slabikar</a>
(with hand written letters continuously
binded one with other) was created in 1997 in pre-Unicode epoch. We can use
such font if the following file is prepared:

<pre>
\def\charenc #1 #2 {\catcode`#1=13 \bgroup \lccode`\~=`#1 \lowercase{\egroup \chardef~=#2}}

\def\csfenc{%
   \charenc á 225 % a-acute
   \charenc Á 193 % A-acute
   \charenc ä 228 % a-diaeresis
   \charenc Ä 196 % A-diaeresis
   \charenc č 232 % c-caron
   \charenc Č 200 % C-caron
   ...
   etc.
}
</pre>

<p>See <a href="http://petr.olsak.net/ftp/olsak/slabikar/csf-enc.tex">csf-enc.tex</a>
for full version of such file. Then you can use it:

<pre>
\input csf-enc
\pdfmapline{=slabikar slabikar &le;slabikar.pfb}
\font\s=slabikar at20pt

{\s\csfenc Tady píšu fontem slabikář česky.}
\bye
</pre>

<p>The letters are set as active but they can be used in \edef or \write
withtout expanding them because their meanig is not macro but chardef
constant.

<p>We don't want to fall to the encodings hell. So, such encoding file is
here only as an example. It can be a part of an old non-Unicode encoded
fonts, but such files will be never the part of OpTeX package. The
hyphenation patterns cannot work properly when such fonts are used.

<p CLASS=datum>(0018) -- P. O. 2020-05-25<p>
<hr>

<p CLASS="lmarg">Verbatim</p>

<h2><a name="inttinoval"></a>Code blocks like in Markdown</h2>

<p>Code blocks are frequently used in Markdown. They are displayed as
an auto-sized, shaded, rounded-corner box around a word.
We can redefine the \_printinverbatim macro in order to do it:

<pre>
\def\_printinverbatim#1{%
   \ovalparams{\lwidth=0pt \lcolor=\LightGrey \fcolor=\LightGrey}%
   \inoval{\setbox0=\hbox{#1}\ht0=1.35ex \dp0=.15ex \box0}}
\activettchar`

This `text` is printed as a `code&amp; {block}`.
</pre>

<p><IMG SRC="../img/inttinoval.png" ALT="Code blocks" border=0>

<p>The \inoval macro is used for shaded rounded-corner box. The \vphantom{ly}
gives a strut inside the text. The height and depth of the text is set to
the constant values in order all ovals have the same height plus depth.

<p CLASS=datum>(0009) -- P. O. 2020-05-02<p>
<hr>

<h2><a name="keepverb"></a>Inline verbatim in macro parameters</h2>

<p>We know that inline verbatim in maro parameters does not work:

<pre>
\def\p#1{print: "#1"}
\activettchar`

\p{test: `\relax x~&amp;` fin.} % error (misplaced align tab)
</pre>

<p>The reason of this error: the parameter text is tokenized when the
parameter is read. The first ` is run after this parameter is completely read. It
changes catcodes but nothing is read directly from file at this time, so 
such catcode setting is ineffective.

<p>We know that the usage of \code{...} is 100% working, but we must to escape
each TeX sensitive character: \p{test: \code{\\relax x\~\&amp;} fin.}.

<p>There exist a method how to "protect" the macro parameter without
escaping the TeX sensitive characters. Use \verbi as a prefix before usage
of the macro:

<pre>
\def\verbi#1{\def\tmp{#1}\begingroup \verbC \verbG}
\def\verbii#1#2#{\def\tmp{#1#2}\verbiiA}
\def\verbiiA#1{\addto\tmp{{#1}}\begingroup \verbC \verbG}
\def\verbC{\catcode`\\=12 \catcode`\#=12 \catcode`\%=12 }
\def\verbG#1{\endgroup \tmp{\scantextokens{#1}}}

\activettchar`
\def\p#1{print: "#1"}

\verbi\p{aha `\relax!@#$%^&amp; uff~` mluff}

\verbii\table{cc}{ a &amp; `\table` \cr b &amp; `&amp;` }
</pre>

<p>The \verbii can be used before \table macro or similar macros 
where the second parameter is important.

<p>Implementaton note: We read the parameter first with category codes
set by \verbC. The \endgroup in the \verbG restores the original category
codes and the macro parameter is represented by \scantextokens{#1}. When
this parameter is processed then the current category codes are used again.
The \verbii macro read parameters like \verbii\table pxto10cm{cc}{...}.
This is the reason of the existence of the \verbiiA auxiliary macro. 

<p>This solution doesn't work in special cases when there are unpaired
braces {} in the verbatim parameter and with macros where the scanned
parameter is pre-processed. Only \code{...} is 100% working.

<p>Compare the complexity of the cprotect.sty LaTeX package with this 5-line
solution.

<p CLASS=datum>(0017) -- P. O. 2020-05-22<p>
<hr>


<p CLASS="lmarg">Math</p>

<h2><a name="bbchar"></a>\bbchar from AMS fonts when Unicode math font is used</h2>

<p>When \fontfam[] is used and \noloadmath is not declared 
then a relevant math font from Unicode math fonts
is loaded too. The single font includes more math alphabets together: math
italics, roman, calligraphic, fractur, greek letters, bbchars etc.

<p>Maybe, your opinion about ideal black board letters (\bbchar's) is
influneced by traditional AMS fonts and it is different than the opinion of
font designer of the used Unicode math font (Latin Modern math font is
typical example of this case). Then you can return to the AMS \bbchars by
following code used <i>after</i> first the \fontfam[] command 
loads the Unicode math font.

<pre>
\addto\_normalmath{\_loadmathfamily 5 msbm }
\addto\_boldmath{\_loadmathfamily 5 msbm }
\def\bbchar{\fam5 \_rmvariables}
</pre>

<p>We need to add \_loadmathfamily 5 to \_normalmath and \_boldmath
in order to load 8 bit version of math fonts as family 5 (5 is the 
first unused math family when Unicode math font is loaded). 
Then we re-define \bbchar macro as
family5 selector and mathcodes of letters must be "normal" (not Unicoded) 
when this 8bit font is used (this is done by \_rmvariables macro).

<p CLASS=datum>(0001) -- P. O. 2020-04-09<p>
<hr>

<h2><a name="matrixx"></a>More comfortable writing of matrices</h2>

<p>It is quite strenuous to put the characters &amp; between every item in
the matrix. In particular, when we are writing a huge amount of matrices.
But we can simplify our writing (and reading the source text too) by 
\replstring macro. We create the \x macro which can be used as a prefix
before \matrix, \pmatrix etc. macros. If it is used then user can write
spaces instead &amp; characters.

<pre>
\def\x#1#2{\def\tmpb{#2}\replstring\tmpb{ }{&}\_ea#1\_ea{\tmpb}}

$$
  \x\pmatrix{x_1 x_2 x_3\cr 12 11 10} = \left[\x\matrix{12 11 10\cr y_1 y_2 y_3}\right]
$$
</pre> 

<p CLASS=datum>(0010) -- P. O. 2020-04-09<p>
<hr>

<p CLASS="lmarg">Tables</p>

<h2><a name="colortab"></a>Colored cells in the table</h2>

<p>We create the macro \colortab which can be used in \thistable
declaration. When this macro is applied then tha background of each cell
can be cloered by chosen color. If
the first item in the cell data is color switcher then this color is used
for the background of the cell. For example:

<pre>
   ... &amp; \Blue Text &amp;        ... % blue background and black text 
   ... &amp; \Green \Red  Text &amp; ... % green background and red text 
   ... &amp; \relax \Blue Text &amp; ... % blue text and default background 
</pre>

<p>The color of the background will stretch as spaces in the common cells in
normal table, i.e. C declarator means that colored space will stretch from
both sides, L declarator means right stretching and R declarator means left
stretching. The spaces from \tabiteml and \tabitemr are colored too.

<p>If \cellcolor sequence is set by \let to the color (example
\let\cellcolor=\Yellow) then this color is used as default background.
If the \cellcolor is undefined then default background is transparent.

<p>You can insert the white space between columns by nonzero \tabskip and
you can insert the white space between lines by \noalign{\kern...}. Example:

<pre>
\thistable={\colortab              % colored cells activated
            \tabstrut={\lower4pt\vbox to15pt{}}        % lines dimensions
            \tabskip=2pt \everycr={\noalign{\kern2pt}} % spaces between cells
            \let\cellcolor=\Yellow % default background color
           } 
\table{clr}{first item      &amp; second &amp; \Blue \White third item \cr 
            next long item  &amp; \Red X &amp; \Green       YES }
</pre>

creates the table:

<p><IMG SRC="../img/tab4-ukazka.png" ALT="Table example" border=0>

<p>Implementation: 

<pre>
\def\tabdC{\futurelet\next\setcellcolor##\end\hfil\hfil} 
\def\tabdL{\futurelet\next\setcellcolor##\end\relax\hfil} 
\def\tabdR{\futurelet\next\setcellcolor##\end\hfil\relax}
\def\tabdP#1{\futurelet\next\setcellcolor##\end\vtop
    {\hsize=#1\relax \baselineskip=\normalbaselineskip
     \lineskiplimit=0pt \noindent\tmp\_unsskip\lower\dp\_tstrutbox\hbox{}}}
\def\colortab{\tablinespace=0pt \let\_paramtabdeclarep=\tabdP
   \let\_tabdeclarec=\tabdC \let\_tabdeclarel=\tabdL \_let\_tabdeclarer=\tabdL}
\def\setcellcolor{%
   \ifx\next\_setcolor \expandafter\setcellcolorC\else \expandafter\setcellcolorD\fi} 
\def\setcellcolorC\_setcolor#1#2\end#3#4{% 
   \ifx#3\vtop \def\tmp{#2}%
      \setbox0=\hbox{\the\tabiteml\vtop{\localcolor#4}\the\tabitemr}%
      \the\tabstrut {\localcolor\_setcolor{#1}\vrule width\wd0}\kern-\wd0 \box0
   \else
      \setbox0=\hbox{{\the\tabiteml\localcolor#2\_unsskip\the\tabitemr}}% 
      {\localcolor\_setcolor{#1}%
       \the\tabstrut\leaders\vrule\hskip\wd0 \ifx#3\hfil plus1fil\fi}% 
      \kern-\wd0 \box0 
      \ifx#4\hfil 
      {\kern-.2pt \localcolor\_setcolor{#1}\leaders\vrule\hskip.2pt plus1fil}\fi
   \fi 
} 
\def\setcellcolorD{\ifx\cellcolor\undefined \let\next=\setcellcolorN 
   \else \def\next{\_ea\_ea\_ea\setcellcolorC\cellcolor}% 
   \fi \next 
} 
\def\setcellcolorN#1\end#2#3{#2\tabiteml{\localcolor#1\unskip}\tabitemr#3}

\def\multispanc#1#2#3{\multispan{#1}% 
   \_ea\_ea\_ea\cellcolexp#2#3\end\hfil\hfil\ignorespaces} 
\def\cellcolexp{\futurelet\next\setcellcolor} 
</pre>

<p>The \setcellcolor macro scans the first token from the cell data. The
macro works in declaration part of the \halign, so the first token is
scanned as the first unexpandable token after expansion. This token is
\_setcolor when color macro is presented here. If this is true then the
\setcellcolorC macro is executed, #1 is the \_setcolor parameter
#2 is the text of the item, #3 and #4 include the
message about the align style. This macro measures the cell text in the box0
and does the colored backround by \leaders. If the first token isn't \global
then the macro \setcellcolorD decides if the \cellcolor is defined. If it is
true then \setcellcolorC is execuded (with patrially expanded \cellcolor as
parameter). Else the \setcellcolorN is executed. This macro prints no
background.

<p>The \multispanc Num \Color {text} can be used for multispan cells, see
<a href="http://petr.olsak.net/opmac-tricks-e.html#multispanc">OPmac trick 103</a>.

<p CLASS=datum>(0004) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="colorlin"></a>Colored lines in the table</h2>

<p>We can see the trend to use colored tables like this:

<p><IMG SRC="../img/tab2-ukazka.png" ALT="Table example" border=0>

<p>The table above can be created by the \table macro from OpTeX:

<pre>
\thistable={\tabiteml={\quad}\tabitemr={\quad}}
\frame{\table{llllll}{\crx
  aa &amp; bb &amp; cc &amp; dd &amp; ee &amp; ff \crx
  gg &amp; hh &amp; ii &amp; jj &amp; kk &amp; ll \crx
  mm &amp; nn &amp; oo &amp; pp &amp; qq &amp; rr \crx
  ss &amp; tt &amp; uu &amp; vv &amp; ww &amp; xx \crx
  ab &amp; cd &amp; ef &amp; gh &amp; ij &amp; kl \crx
  mn &amp; op &amp; qr &amp; st &amp; uv &amp; wx}}
</pre>            

<p>We need to define the \crx macro which inserts the grey rule before each
odd line into the vertical list:

<pre>
\newcount\tabline  \tabline=1 
\def\crx{\crcr \ifodd\tabline \colortabline \else\noalign{\hrule height0pt}\fi 
         \global\advance\tabline by1 } 
\def\colortabline{\noalign{\localcolor\LightGrey 
   \hrule height\ht\strutbox depth\dimexpr\dp\strutbox +2\tablinespace\relax 
   \kern-\dimexpr\ht\strutbox+\dp\strutbox +2\tablinespace}} 
</pre>

<p>The \tabline counter counts the lines in the table and inserts the
grey backgroud for each odd \tabline. The last line must not be terminated
by \crx macro.

<p CLASS=datum>(0005) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="booktabs"></a>Tables like in booktabs package</h2>

<p>The orthodox advocates of LaTeX booktabs package don't like the table
formats from the example above and they point out that I am loser because I
don't know that the vertical rules in the table are out. Only horizontal
rules are allowed but not double rules. And less rules is better than more.
They have the following example in the documentation:

<p><IMG SRC="../img/tab3-ukazka.png" ALT="examle of table" border=0>

<p>we can create such table by OpTeX and without booktabs package:

<pre>
\thistable={\tabiteml={}\tabitemr={}\rulewidth=.2pt}
\table{l(\quad)lr}{                           \crtop 
  \mspan2[c]{Item}         &amp;                  \crlp{1-2} 
   Animal    &amp; Description &amp; \quad Price (\$) \crmid 
   Gnat      &amp; per gram    &amp;      13.65       \cr 
             &amp; each        &amp;       0.01       \cr 
   Gnu       &amp; stuffed     &amp;      92.50       \cr 
   Emu       &amp; stuffed     &amp;      33.33       \cr 
   Armadillo &amp; frozen      &amp;       8.99       \crbot} 
</pre>

<p>We only need to define \crtop, \crmid, \crbot macros:

<pre>
\def\crtop{\crcr \noalign{\hrule height.6pt \kern2.5pt}} 
\def\crbot{\crcr \noalign{\kern2.5pt\hrule height.6pt}} 
\def\crmid{\crcr \noalign{\kern1pt\hrule height.4pt\kern1pt}} 
</pre>

<p>We need to set default rulewidth for this table to .2pt
(it is generated by \crlp{1-2}). Other rules have explicitly declared 
thickness.
We have to remove the spaces left in the first cell and right in
the last cell because the rules have to be aligned with the text. This is a
reason why the \tabitemr and \tabiteml are empty. The space between first
and second column is created by (\quad) in the declaration. The same space
before third column is caused by \quad before "Price". 

<p CLASS=datum>(0007) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="decdigits"></a>Decimal digits aligned by the decimal point</h2>

<p>We declare new column letter N with numeric parameter: it gives the
maximal number of the digits used after the decimal point in the column. 
Table items can be in the form "xxx.xx" or ".xxx" or "xxx.". All these
variants are aligned by the decimal point. The deciaml point itself is
printed by the \decimalpoint macro, which can be defined as period or 
as comma (comma is used in Czech traditional typography for decimal numbers).
The latest form "xxx." is aligned too but the decimal point is not printed.
If the table item does not have any decimal point (for example it is the
title of the column) then the text is centered.

<pre>
\def\_paramtabdeclareN#1{\the\tabiteml\hfil\adigit{#1}##.\relax\the\tabitemr} 
\def\adigit#1#2.#3{\ifx\relax#3\hfil#2\_unsskip\hfil \else
    \tmpdim=.5em \tmpdim=#1\tmpdim $#2$%
    \_ea \ifx.#3\relax\phantom\decimalpoint \else \decimalpoint \fi
    \_ea \adigitA\fi #3%
}
\def\adigitA#1.\relax{\hbox to\tmpdim{$#1$\hss}} 

% test:

\table{r N3 l}{
       &amp; results &amp; \crl
   aha &amp;   1.24  &amp; uff \cr
   uha &amp;    .123 &amp; mm  \cr
    nn &amp;  24.42  &amp; rr  \cr
     p &amp;   2.    &amp; r   \cr
     q &amp;    .24  &amp; s   }
</pre>

<p>The N declararor runs \adigit macro. This macro reads the item data until
decimal point is found. The hidden decimal point is in the right part of
declaration, so we are sure that the scanning of the parameter finishes.
If this compensatory decimal point is scanned (i.e. no decimal point is in the
item data, #3 is \relax) then we write the text centered. Else we write left
part of the number, \decimalpoint (or \phantom\decimalpoint if no digits
follows) and the rest is printed in the box with fixed width given by the 
number of digits declared in N parameter. 

<p>If you don't want to specify the maximal number of digits, you can
declare D column declarator (without parameter) and use the \eqbox macro
from OpTeX.

<pre>
\def\_tabdeclareD{\the\tabiteml\hfil\adigitD##.\relax\the\tabitemr} 
\def\adigitD#1.#2{\ifx\relax#2\hfil#1\_unsskip\hfil \else
    $#1$%
    \_ea \ifx.#3\relax\phantom\decimalpoint \else \decimalpoint \fi
    \_ea \adigitAD\fi #3%
}
\def\adigitAD#1.\relax{\eqbox l[D:\the\tabnum/\the\colnum]{$#1$}} 

\newcount\tabnum
\everytable{\global\advance\tabnum by1}
</pre>

<p>We must to specify the label for \eqbox uniquely in whole document. So we
have to set numbers to each table and use the label in the form
D:tablenum/colnum. Note that the column number \colnum is calculated by the 
\table macro and it is available for each column used in this macro. 

<p CLASS=datum>(0015) -- P. O. 2020-05-20<p>
<hr>

<h2><a name="longtable"></a>Long table across multiple pages</h2>

<p>The \table macro runs \halign primitive inside \vbox. This is reason why
it is unbreakable to multiple pages. But you can deactivate this \vbox. Suppose
that you have a lot of lines like this:

<pre>
\def\ltable{\bgroup \let\_tablebox=\egroup \table} % the \vbox is deactivated

\ltable{|c|c|}{data &amp; data \cr 
               data &amp; data \cr 
      ... much more &amp; data ... \cr} 
</pre>

<p>Now, the \halign can work in main vertical mode and its lines are breakable to
more pages. But you can see more problems. If the \table is in main vertical
mode, then all lines are at the left margin of the page box. Maybe, you want
to see them in the center. This can be done by:

<pre>
\thistable{tabskipl=0pt plus1fil \tabskipr=\tabskipl}
\ltable to\hsize {|c|c|}{data &amp; data \cr 
                         data &amp; data \cr 
                ... much more &amp; data ... \cr} 
</pre>

<p>OK, the table is in the center. But \crl does not do what we want. We can use
\crli instead it. If there is \crli at each line, then we see next problem.
The horizontal rule is at the bottom of the page but not at the top of next
page. You can re-define \crli like this:

<pre>
\thistable{\tabskipl=0pt plus1fil \tabskipr=\tabskipl
           \def\crli{\_crli \noalign{\penalty0\kern-.4pt}\_crli\noalign{\nobreak}}}
\ltable to\hsize{|c|c|}{\crli
                  data &amp; data \crli
                  data &amp; data \crli 
         ... much more &amp; data ... \crli} 
</pre>

<p>The trick is based on the fact, that there are two horizontal rules (one
over another) between each lines. If a page break occurs (at \penalty0)
then one horizontal rule is at the bottom and second one at the top of next
page. 

<p>The tricks above are only very simple examples of long tables. If you
need something more smart then you can use fixed witdh of table items and
each line is one \hbox. You need not to use \halign. Or you can use \eqbox
from OpTeX. Or you can resample the boxes created by \halign. This
last approach allows to repeat a table header at the top of each page again:

<pre>
\def\longtable#1#2{\goodbreak \bgroup \tablinespace=0pt \let\_zerotabrule=\empty 
   \setbox0=\table{#1}{\strutT\relax #2} 
   \setbox1=\vbox{\unvbox0 \setbox2=\vbox{}\revertbox} 
   \setbox2=\vbox{\unvbox2 \global\setbox4=\lastbox\unskip \global\setbox5=\lastbox\unskip}
   \whatfree4 \advance\tmpdim by-.8pt \ifdim\tmpdim&le;\baselineskip \vfil\break \fi 
   \offinterlineskip \crule\center4\crule\center5 \printboxes 
   \center5\crule \egroup \goodbreak 
}
\def\whatfree#1{\tmpdim=\vsize \advance\tmpdim by-\pagetotal 
   \advance\tmpdim by-\prevdepth \advance\tmpdim by-.4pt 
   \advance\tmpdim by-\ht#1 \advance\tmpdim by-\dp#1 \advance\tmpdim by-\ht5 } 
\def\revertbox {\setbox0=\lastbox\unskip 
   \ifvoid0 \else \global\setbox2=\vbox{\unvbox2\box0} \ea\revertbox\fi } 
\def\printboxes{\setbox2=\vbox{\unvbox2 \global\setbox0=\lastbox\unskip} 
   \ifvoid0 \else \whatfree0 
      \ifdim\tmpdim&le;0pt \center5\crule\vfil\break \crule\center4\crule\center5 \fi 
      \center0 \nobreak \printboxes \fi } 
\def\crule{\centerline{\hbox to\wd4{\hrulefill}}\nobreak} 
\def\center#1{\centerline{\copy#1}\nobreak} 

\def\strutT {\vrule height1.8em depth.8em width0pt} % strut for the title

\longtable {|c|c|c|}{ head1 &amp; head2 &amp; head22 \cr % title 
                                             \tskip5pt
                      data2 &amp; data2 &amp; data2 \cr
                      data3 &amp; data3 &amp; data3 \cr
                      data4 &amp; data4 &amp; data4 \cr 
                       data &amp; data  &amp; data \cr 
              ... much more &amp; data  &amp; data ...} 
</pre>

<p>The head1 , head2 and head22 is repeated with rules above and below this
head at the top of each page. The \tskip is mandatory here and it separates
the bottom rule of the head from the data. This solution is copied from
OPmac trick 0024.


<p CLASS=datum>(0016) -- P. O. 2020-05-20<p>
<hr>

<p CLASS="lmarg">Macro tricks</p>

<h2><a name="keyval"></a>The options in key=value dictionaries</h2>

<p>We want to set the data in the form keyA=valueA, keyB=valueB etc. i.e.
the comma separated list of equations. The list of
key=value pairs is read by \readkv\defaultvalues macro.
Next, the macro \kv{key} expands to the
appropriate value or to \kvunknown, if the key is not set.
For example:

<pre>
\def\mymacrodefault          {color={}, width=0.4pt} 
\optdef\mymacro [] {\bgroup 
   \readkv\mymacrodefault
   \kv{color}% color setting 
   \let\vruleprimitive=\vrule 
   \def\vrule{\vruleprimitive width\kv{width}}% vrule width setting 
   ... 
   \egroup 
} 
</pre>

<p>The user can write the \mymacro without parameters or (for example)
\mymacro[width=.7pt] or \mymacro[width=.8pt, color=\Red].

<p>The macros \kv and \kvread are implemented here:

<pre>
\def\kv#1{\trycs{kv:#1}{\kvunknown}}
\def\kvunknown{???} 
\def\kvscan #1#2=#3,{\ifx#1,\else \sdef{kv:#1#2}{#3}\_ea\kvscan\fi} 
\def\readkv#1{\_ea\def\_ea\tmpb\_ea{#1,}\_ea\addto\_ea\tmpb\_ea{\the\opt}%
   \replstring\tmpb{= }{=}\replstring\tmpb{ =}{=}%
   \_ea \kvscan \tmpb,,=,%
}
</pre>

<p>The \readkv macro prepares options in \tmpb. It removes optional spaces
around equal sign by \replstring and runs \kvscan macro.

<p>If we want to mix single options with key=value pairs, for example

<pre>
\mymacro [width=1mm, draft]
</pre>

<p>then we must to \replstring such single options to key=value pairs before
\readkv is used, for example:

<pre>
\def\mymacrodefault          {color={}, width=0.4pt, draftmode=0} 
\optdef\mymacro [] {\bgroup 
   \_ea\addto\_ea\mymacrodefault\_ea{\_ea,\the\opt}\opt={}%
   \replstring\mymacrodefault{draft}{draftmode=1}%
   \readkv\mymacrodefault
   \kv{color}% color setting 
   \let\vruleprimitive=\vrule 
   \def\vrule{\vruleprimitive width\kv{width}}% vrule width setting 
   ... 
   \egroup 
} 
</pre>

<p CLASS=datum>(0008) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="condi"></a>Structured conditionals</h2>

<p>The usage of \if* conditionals is very uncomfortable if we need to
use some structured logical expression in our macros 
with brackets () and logical AND, OR. This is not implemented at 
TeX primitive level, unfortunately. But we can use the following trick:

<pre>
\def\cond[#1:#2]{#1 1\else0\fi}

%%        IF      (           a=a     AND          c=c      ) OR          e=f       then 
\ifnum 0&lt;\numexpr ( \cond[\ifx aa:\fi] * \cond[\ifx cc:\fi] ) + \cond[\ifx ef:\fi] \relax
     YES \else NO \fi
</pre>

<p>The \cond macro has syntax: \cond[primitive conditional:\fi] where
primitive conditional is \ifx, \if, \ifnum, \ifvoid, \ifmmode, \ifdim, etc.
followed by elementary conditional expression which syntax is dependent on
used \if primitive. The \fi prameter is mandatory here because we need to
have the whole construction \if-skipable.

<p>If you want to use AND logical conjunction write *. If you want OR write
+. Use brackets () as usual. The whole \if construction is fully expandable.

<p>You can add another logical operators if you want:

<pre>
\def\IMPL#1{\IMPLa#1\relax}
\def\IMPLa#1=>#2\relax{\ifnum #1>#2 0\else 1\fi} 

\ifnum 0&lt;\numexpr 
%        (         a=a      =>           c=d     ) AND          2=2        then
   \IMPL{ \cond[\if aa:\fi] => \cond[\if cd:\fi] } * \cond[\ifnum2=2:\fi] \relax 
   Yes \else No \fi
</pre>

<p CLASS=datum>(0019) -- P. O. 2020-05-27<p>
<hr>

<h2><a name="setpos"></a>Absolute positions on the page</h2>

<p>You can write \setpos[label] somewhere and the position of such \setpos[label]
can be referenced by \posx[label], \posy[label] and \pospg[label].
The first two macros expand to x and y position measured from left-bottom 
corner of the page (dimen values) and \pospg[label]
expands to the page number in the document (counted from one at beginning of
the document).

<p>These values are available in second (and more) TeX run, because the
information is saved to ref file and restored from it at the beginning of
TeX job. If these vaules are not known then mentioned macros expand to 0sp,
0sp and 0.

<pre>
\refdecl{
   \def\Xpos#1#2#3{\sxdef{pos:#1}{{#2}{#3}\_currpage}}
}

\def\setpos[#1]{\openref\pdfsavepos\_wref\Xpos{{#1}{\the\pdflastxpos}{\the\pdflastypos}}}

\def\posx [#1]{\_ea \posi   \romannumeral-`\.\trycs{pos:#1}{{0}{0}{0}{0}}sp}
\def\posy [#1]{\_ea \posii  \romannumeral-`\.\trycs{pos:#1}{{0}{0}{0}{0}}sp}
\def\pospg[#1]{\_ea \posiii \romannumeral-`\.\trycs{pos:#1}{{0}{0}{0}{0}}}

\def\posi   #1#2#3#4{#1}
\def\posii  #1#2#3#4{#2}
\def\posiii #1#2#3#4{#3}
</pre>

<p>The coordinates are saved to the .ref file in the format \Xpos{x-pos}{y-pos}. 
The \Xpos macro defines \pos:label as {x-pos}{y-pos}{total-pg}{rel-pg}.
We need to read only given parameter by \posi, \posii or \posiii auxiliary
macros. The \romannumeral-`\. trick does (empty) expansion of \trycs until first {
occurs.

<p>This example shows the usage of \refdecl macro from OpTeX and \pdfsavepos,
\pdflastxpos, \pdflastypos pdfTeX primitives.

<p>Unusable example: the following code draws the line from current position
to the left-bottom corner of the page.

<pre>
Text text\setpos[A]\pdfliteral{q 0 0 m -\bp{\posx[A]} -\bp{\posy[A]} l S Q}
</pre>

<p CLASS=datum>(0020) -- P. O. 2020-05-27<p>
<hr>

<h2><a name="tabs"></a>Tabbing macros</h2>

<p>Plain TeX provides tabbing macros but OpTeX does not, bacuase old typewriter
style for alignment is not preferred. Use \table instead this. 
Or you can set such typewriter TABs by
following macros. Moreower, these macros are more intelligent than the Plain
TeX equivalent.

<p>You can say \settabs 4\column. Then the \hsize is divided to four
equal-size parts, each of them begins by a TAB position and the last one
ends by a TAB position too. I.e. there are five equi-distant TAB positions. 
Then you can type

<pre>
\tabs first text &amp; second text &amp; third text &amp; fourth text &amp; other text \cr
</pre>

<p>The left boundary of the first text is aligned with first TAB position. The
next text is aligned to next TAB position. But it needs not to be exactly the second
one: all TAB positions which are left to the actual text position are
ignored and the first non-ignored TAB position is used. 
This means that the text is never overlapped. This is real behavior 
of old typewriters. Go to a Museum of Technology and try it.
This is the significant difference from plain TeX macros.

<p>You can set the TAB positions by invisible sample line too:

<pre>
\settabs\tabs &amp;textA&amp;textB&amp;textC\cr
</pre>

<p>Each &amp; or \cr gives one TAB position. If you did not use first &amp;
immediately after \tabs then first TAB position is shifted from left
boundary of lines. 

<p>The implementation looks like:

<pre>
\def\tabs #1\cr{\setbox0=\hbox\bgroup \tabA #1&amp;\cr&amp;}
\def\tabA #1&amp;{\ifx\cr#1\egroup\box0 \else 
   \egroup 
      \tmpdim=\maxdimen \ea\tabB \tabsdata {}\relax
      \ifdim \tmpdim=\maxdimen \tmpdim=0pt
      \else \advance\tmpdim by-\wd0 \fi
   \setbox0=\hbox\bgroup \unhbox0 \kern\tmpdim \ignorespaces#1\unskip\kern1sp
   \_ea\tabA \fi
}
\def\tabB #1{\ifx^#1^\else \unless\ifdim \wd0>#1 \tmpdim=#1 \tabC \fi \ea\tabB \fi} 
\def\tabC #1\relax {\fi\fi}

\def\settabs #1{\def\tabsdata{}\ifx\tabs#1\_ea\settabstext \else\_ea\settabscols \fi #1}
\def\settabscols #1\columns{\tmpdim=\hsize \divide\tmpdim by#1\relax
   \fornum 0..#1 \do {\edef\tabsdata{\tabsdata{\the\dimexpr##1\tmpdim\relax}}}}

\def\settabstext #1#2\cr{\setbox0=\hbox\bgroup \settabA #2&amp;\cr&amp;}
\def\settabA #1&amp;{\ifx\cr#1\egroup \edef\tabsdata{\tabsdata{\the\wd0}}\else
    #1\egroup \edef\tabsdata{\tabsdata{\the\wd0}}%
    \setbox0=\hbox\bgroup \unhbox0
    \_ea\settabA \fi
}
\def\tabsdata{}  % default: no tabulators set
</pre>

<p>The \tabsdata macro includes TAB positions in the format {0pt}{100pt}{200pt}.
Of course, you can define directly TAB positions by 
\def\tabsdata{{0cm}{2cm}{4cm}{6cm}{8cm}}, for example.

<p>The \tabs macro opens \setbox0=\hbox\bgroup, sets the appropriate text to it, closes
it, measures \wd0, sets appropriate kern, opens \setbox0=\hbox\bgroup
\unhbox0 again ad does this in a loop.

<p CLASS=datum>(0021) -- P. O. 2020-05-27<p>
<hr>

<p CLASS="lmarg">Others</p>

<h2><a name="diff"></a>Showing differences between versions of the document</h2>

<p>If we have two versions of the same document: document-old.tex and
document-new.tex, then we can print document-new.tex with colorized parts of
the text, which is new in this new verison of the document. Define:

<pre>
\def\diffstart/{{\nolocalcolor\Red}}
\def\diffstop/{{\nolocalcolor\Black}}

\regmacro {\def\diffstart/{}\def\diffstop{}} 
          {\def\diffstart/{}\def\diffstop{}}  
          {\def\diffstart/{}\def\diffstop{}}
</pre>

<p>and run

<pre>
wdiff -1 --start-insert='\diffstart/' --end-insert='\diffstop/' \
      document-old.tex document-new.tex > diff.tex
optex diff.tex
</pre>

<p>The resulting PDF have the new phrases in red color. 

<p>Because we are using \localcolor by default and we set these two
colors as \nolocalcolor, then there can be little problems. But most cases are
solved good. Moreover, it is simple and effective.

<p>Only new texts are highigted without any change of formatting the
document. If you need to see colored deleted texts, then you can show it 
on the ANSI terminal:

<pre>
wdiff -n -w $'\033[30;41m' -x $'\033[0m' -y $'\033[30;42m' -z $'\033[0m' \
      document-old.tex document-new.tex | less -R
</pre>

<p>This trick was inspired from an idea by Daniel Gromada. 
He suggested it for the OPmac tricks set.

<p CLASS=datum>(0014) -- P. O., D. G. 2020-05-17<p>
<hr>

<h2><a name="overleaf"></a>How to run OpTeX at Overleaf</h2>

<p>Overleaf is LaTeX oriented site, but we can run most recent OpTeX version
here if we do a set of obscure and dirty tricks.

<p>First of all, we have to generate optex.fmt binary file at Overleaf. This
file is typically binary incompatible in various computers and various
versions of LuaTeX, so you cannot generate it at your computer and
simply upload it. Create a zip file with optex files in your computer:

<pre>
cd ??where optex/ directory is
zip -r optex-recent.zip optex/
</pre>

<p>Create a new Overleaf project and upload optex-recent.zip. Create the
main.tex file with the following contents:

<pre>
\documentclass[a4paper]{article}
\usepackage{bashful}

\begin{document}

\bash[script,stdout,stderr]
unzip -o optex-recent.zip
cd optex/base/
luatex -ini optex.ini
rm *.opm
\END

\end{document}
</pre>

<p>Click "Recompile". The oputput PDF should show the messages from OpTeX
format generation. Click on the icon just right to "Recompile" (logs and
output files), scroll the window down and click on the button "Other logs
&amp; files". The <b>optex.fmt</b> should be here.

<p>The "Other logs &amp; files" are temporary files: Unfortunately, they are
removed before each TeX run. So, you need to download optex.fmt to your
computer and upload again to the Overleaf project. Do it now.

<p>The same is true for unzipped files from optex-recent.zip. They are lost
in the next TeX run. This is reason why we cannot use files from
optex-recent.zip when processing OpTeX documents and we must to 
upload all *.opm files to the Overleaf project <b>again</b>.
Create the subdirectory <b>optex/</b> (lowercase letters) in the project and upload all
*.opm files to this directory. The uploader accepts maximum 40 files per one
upload action, so more than 80 files from OpTeX package need to be uploaded
in three steps. The directory structure in the optex/ directory can be
arbitrary, for example all *.opm files are directly in the optex/ directory.
Alternative: you can upload not all *.opm files but only these files needed
at OpTeX runtime: f-*.opm, hisyntax-*.opm, mathclass.opm, unimath-codes.opm,
unimath-table.opm, usebib.opm, bib-*.opm, slides.opm.

<p>Prepare the <b>latexmkrc</b> at main level of directories in the Overleaf
project with the one-line content:

<pre>
$lualatex = 'TEXINPUTS=./optex//:$TEXINPUTS luatex -fmt=optex %O %S';
</pre>

<p>Upload all files from OpTeX demo/ directory to the main directory level
of Overleaf project, especially op-demo.tex and op-ring.png files. This is only
for testing.

<p>Select from main Overleaf menu: Compiler: LuaLaTeX, main document:
op-demo.tex, Code check: Off. 

<p>Now, you have optex.fmt, latexmkrc, op-demo.tex, op-ring.png in the main
directory. Try the buttom "Recompile" and wait a while 
(LuaTeX needs to initialize the OTF font databases when it runs first). If 
you see the PDF result: "Demonstration", congratulations! The
first run gives the result without TOC, second "Recompile" gives TOC too.

<p CLASS=datum>(0022) -- P. O. 2020-05-29<p>
<hr>


</td></tr>
</table>

</BODY></HTML>
