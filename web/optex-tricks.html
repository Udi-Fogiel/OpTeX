<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<HTML><HEAD>
<META HTTP-Equiv="Content-Type" CONTENT="text/html; charset=utf8">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">

<TITLE>OpTeX - tricks, tips</TITLE>

<style type="text/css">
<!--
 .lmarg {margin-left: -200px; margin-top: -15px;
        width: 200px; height: 0px;
        font-weight: bold;
        text-align: right;
        position: relative; top: 15px; left: -15px; 
        overflow; }
 .rmarg {margin-left: 13px; margin-top: -15px;
        width: 200px; height: 0px;
        text-align: left;
        position: relative; top: 15px; right: -600px; 
        overflow; }
  .datum {text-align: right; margin-bottom: -10px; font-size: 80%}
  p   { text-align: justify }
  pre { width: 600px; overflow; }  
-->
</style>

</HEAD>
<BODY bgcolor="#FFFFFF">

<table width="600" border="0" cellspacing="0" cellpadding="0"
align="center">
<tr><td>
  <div STYLE="text-align: center">
  <a href="http://petr.olsak.net/optex"><IMG SRC="../img/optex-logo.jpg" ALT="OpTeX" border=0></a>
  </div>


<h1 STYLE="text-align: center">OpTeX - tips, tricks, howto</h1>


<p>This page includes solutions of various tasks when 
<a href="http://petr.olsak.net/optex/">OpTeX</a> is used.
Each solution would be ``small'', it means you can see whole solution at
once in your www browser. The constellation of each solution is similar: user
description followed by macro code followed by explanation of the macro
code. User can copy and paste the macro code to his/her document simply by
the mouse.

<p>If there exists any tip from you, OpTeX user, don't hesitate please and send
me it. I'll welcome it and save it here (with the author of the solution
mentioned).

<p><a href="http://petr.olsak.net/opmac-tricks-e.html">OPmac tricks</a> 
can be used too but re-implementation of the code is probably
needed because OPmac uses different internal macros than OpTeX.
The important OPmac tricks will be re-implemented here soon.

<p>Note that several OPmac tricks are implemented directly into OpTeX:

<ul>
<li> \colordef does colors mixing.
<li> \morecolors reads color names from xcolor package.
<li> Footnotes has their own color stack.
<li> \transformbox applies linear transformations.
<li> \oval, \circle create colored oval or circle around text.
<li> \clipinoval, \clipincircle declare clipping path for images.
<li> \hisyntax performs syntax highlighting for C, Python, TeX, 
     html and XML languages.
<li> \draft and \showlabels can be used for printing labels in draft mode.
<li> Options in key=value dictionaries.
<li> \lipsum prints the text Lorem ipsum dolor sit.
<li> \mathbox creates a \hbox in math list with size-context.
<li> \numberedpar helps with creating numbered Theorems, Definitions etc.
<li> \inspic syntax allows alternative \inspic{filename.ext} without
     space separator.
<li> \inkinspic inludes pictures with labels generated by Inkscape.
<li> \crlp is implemented for tables.
<li> Tables to given width.
<li> Variations of paragraphs with p declarator.
<li> Vertical centered text in more rows in tables. 
<lI> Eqbox: equal width of boxes across whole document.
<li> \slides style allows to create presentations.
<li> \usebib reads directly .bib databases without any external program.
<li> Index allows hyperlinked pages and alternative page lists.
</ul>

<hr>

<h2>Contents</h2>

<ul>
<li>Fonts
<ul>
    <li><a href="#scaleto">Text size changed to the desired width</a>
    <li><a href="#fawesome">More than 1300 icons from Awesome5 fonts</a>
    <li><a href="#nonunicode">Fons with non-Unicode encoding</a>
    <li><a href="#ul">Marking parts of text</a>
</ul>

<li>Lists
<ul>
    <li><a href="#multilist">List items multi-numbered at arbitrary level</a>
    <li><a href="#easylist">Depth of the list given by number of *</a>
</ul>

<li>Verbatim
<ul>
    <li><a href="#inttinoval">Code blocks like in Markdown</a>
    <li><a href="#keepverb">Inline verbatim in macro parameters</a>
</ul>

<li>Graphics
<ul>
    <li><a href="#gradients">Color gradients</a>
    <li><a href="#carrows">Curved arrows</a>
    <li><a href="#circletext">Text around a circle</a>
</ul>

<li>Math
<ul>
    <li><a href="#bbchar">\bbchar from AMS fonts when Unicode math font is used</a>
    <li><a href="#matrixx">More comfortable writing of matrices</a>
    <li><a href="#biglr">Bigger outer parentheses automatically set</a>
    <li><a href="#textinmath">Text fonts in math mode</a>
    <li><a href="#torighteq">Equation marks in atypical cases</a>
    <li><a href="#addumathfont">Loading additional Unicode math fonts</a>
    <li><a href="#dots">Intelligent \dots like in AMSTeX</a>
</ul>

<li>Tables
<ul>
    <li><a href="#colortab">Colored cells in the table</a>
    <li><a href="#colorlin">Colored lines in the table</a>
    <li><a href="#booktabs">Tables like in booktabs package</a>
    <li><a href="#decdigits">Decimal digits aligned by the decimal point</a>
    <li><a href="#longtable">Long table across multiple pages</a>
    <li><a href="#tablevcent">Vertically centered paragraphs in table</a>
    <li><a href="#dnaligned">The decimal point aligned in the table</a>
    <li><a href="#tnote">Table notes</a>
</ul>

<li>Text blocks
<ul>
    <li><a href="#greyblock">Text blocks with grey background splittable to more
    <li><a href="#blocksum">The checksum of the text blocks</a>
    <li><a href="#blockoval">Text blocks in ovals</a>
</ul>

<li>Macro tricks
<ul>
    <li><a href="#condi">Structured conditionals</a>
    <li><a href="#setpos">Absolute positions on the page<a>
    <li><a href="#anodes">Drawing to given nodes</a>
    <li><a href="#tabs">Tabbing macros</a>
    <li><a href="#vardef">Macro with variable number of arguments in braces</a>
    <li><a href="#import">The import package</a>
    <li><a href="#num">Numbers printed in three-digits groups</a>
    <li><a href="#scantok">Expandable token-per-token scanner</a>
    <li><a href="#balancing">Nested brackets of another type than {}</a>
</ul>

<li>Sections
<ul>
    <li><a href="#seccc">New level o sections</a>
</ul>

<li>Slides
<ul>
    <li><a href="#slider">Navigation bar for selecting pages</a>
</ul>

<li>Languages
<ul>
    <li><a href="#ngerman">The german.sty and ngerman.sty implementation</a>
</ul>

<li>Others
<ul>
    <li><a href="#version">Version number of the format</a>
    <li><a href="#diff">Showing differences between versions of the document</a>
    <li><a href="#overleaf">How to run OpTeX at Overleaf</a>
</ul>


</ul>
<br><hr>

<p CLASS="lmarg">Fonts</p>

<h2><a name="scaleto"></a>Text size changed to the desired width</h2>

<p>We prepare the macro \scaleto size {text} which prints “text” by actual font rescaled, 
that the “text” width is the given size.

<pre>
\def\scaleto#1#{\def\tmp{#1}\scaletoA}
\def\scaletoA#1{\setbox0=\hbox{{#1}}%
   \edef\tmp{\expr{\bp{\tmp}/\bp{\wd0}}}%
   \transformbox{\pdfscale{\tmp}{\tmp}}{#1}}

\scaleto 7cm {text} % the "text" has 7cm width 
</pre>

<p>The desired dimension is saved to the \tmp macro and \scaletoA does the real work. It 
saves the text to \hbox 0 and calculate the coefficient of scaling as \tmp/\wd0.
This coefficient is saved to \tmp again and used in the \transformbox{\pdfscale}{} macro.

<p>You can compare the solution of similar task in OPmac trick 027. 
You can see that we have more powerful tools for calculation than in OPmac: 
\bp converts the dimension to Adobe points and \expr calculates the ratio.

<p>If you are using a font family with optical sizes, then we need to scale
to right optical size. Then we can use \scaletof size {text}.

<pre>
\def\scaletof#1#{\def\tmp{#1}\scaletofA}
\def\scaletofA#1{\setbox0=\hbox{{#1}}%
   \edef\tmpa{\expr{\bp{\tmp}/\bp{\wd0}}}%
   \scaletoA{\setfontsize{mag\tmpa}\currvar#1}}
</pre>

<p>The \setfontsize{mag factor} is calculated, where the factor is the
scale ratio calculated and saved in the \tmpa. 
When the font is changed then the result is not exactly 
the desired width, because new font have a little different proportions. 
So previous \scaletoA is called again to reach the exact accuracy.

<p CLASS=datum>(0011) -- P. O. 2020-05-06<p>
<hr>

<h2><a name="fawesome"></a>More than 1300 icons from Awesome5 fonts</h2>

<p>The TeX distribitions include OTF fonts FontAwesome5Free-Solid-900,
FontAwesome5Brands-Regular-400 and FontAwesome5Free-Regular-400
with icons (dingbats) like keyboard, house, faces etc. See the
<a href="http://mirrors.ctan.org/fonts/fontawesome5/doc/fontawesome5.pdf">documentation 
   from fontawesome5 LaTeX package</a> 
where all these dingbats are listed. 
We want to use them. The following macro code does it:

<pre>
\initunifonts  % we need to load OTF fonts
\font\tenfafree      =[FontAwesome5Free-Solid-900]
\font\tenfabran      =[FontAwesome5Brands-Regular-400]
\font\tenfafreeregul =[FontAwesome5Free-Regular-400]
\protected\def\faregul#1{{\let\tenfafree=\tenfafreeregul #1}}
\protected\def\fafree{\tenfafree\resizethefont}
\protected\def\fabran{\tenfabran\resizethefont}
\def\__fontawesome_def_icon:nnnnn#1#2#3#4#5{%
   \ifx^#1^\else
      \getfourtokens\tmp#3\relax 
      \protected\edef#1{{\csname fa\tmp\endcsname \char#5}}%
   \fi
}
\def\getfourtokens#1#2#3#4#5#6\relax{\def#1{#2#3#4#5}}
\input fontawesome5-mapping.def
\__fontawesome_def_icon:nnnnn{\faWifi}{wifi}{free3}{213}{"F1EB}
</pre> 

<p>Now, you can use all control sequences listed in the fontawesome5
documentation. For example \faHouseUser, \faAngry, \faApple, etc. 
The alternative syntax like \faIcon{Angry} is not supported.
A few icons are in its "regular" variants. They are listed as 
\faAngry[regular] in the fontawesone5 documentation. 
These icons are available by the \faregul prefix in uour macro, 
i.e. \faregul\faAngry.

<p><b>Notice to the implementation</b>. The three fonts with dingbats are
loaded as \tenfafree, \tenfabran and \tenfafreeregul. The third one includes
the "regular" variants. The macros \fafree amd \fabran select these fonts
at current size used by Font Selection System from OpTeX.

<p>We need to read the mapping from names to the font codes. It is saved in
the fontawesome5-mapping.def. The set of \__fontawesome_def macros
are used here. We define such macro in order to read this mapping and then
we do \input fontawesome5-mapping.def.

<p>Of course, if Marcel Krüger make changes in the fontawesome5-mapping.def
file syntax, we must to redeclare our macros. I hope that this syntax is
more or less stable.

<p>You can compare the complexity of macros in the LaTeX implemenation with
these 16 lines of plain TeX macros. Only TeX primitives are used here (and
two OpTeX macros \initunifonts and \resizethefont). This is one of reasons
why I like plain TeX.

<p CLASS=datum>(0012) -- P. O. 2020-05-08<p>
<hr>

<h2><a name="nonunicode"></a>Fonts with non-Unicode encoding</h2>

<p>OpTeX does not prefer such fonts but sometimes there are a reason to use
them. For example the font
<a href="http://petr.olsak.net/ftp/olsak/slabikar/slabi.pdf">slabikar</a>
(with hand written letters continuously
binded one with other) was created in 1997 in pre-Unicode epoch. We can use
such font if the following file is prepared:

<pre>
\def\charenc #1 #2 {\catcode`#1=13 \bgroup \lccode`\~=`#1 \lowercase{\egroup \chardef~=#2}}

\def\csfenc{%
   \charenc á 225 % a-acute
   \charenc Á 193 % A-acute
   \charenc ä 228 % a-diaeresis
   \charenc Ä 196 % A-diaeresis
   \charenc č 232 % c-caron
   \charenc Č 200 % C-caron
   ...
   etc.
}
</pre>

<p>See <a href="http://petr.olsak.net/ftp/olsak/slabikar/csf-enc.tex">csf-enc.tex</a>
for full version of such file. Then you can use it:

<pre>
\input csf-enc
\pdfmapline{=slabikar slabikar &le;slabikar.pfb}
\font\s=slabikar at20pt

{\s\csfenc Tady píšu fontem slabikář česky.}
\bye
</pre>

<p>The letters are set as active but they can be used in \edef or \write
withtout expanding them because their meanig is not macro but chardef
constant.

<p>We don't want to fall to the encodings hell. So, such encoding file is
here only as an example. It can be a part of an old non-Unicode encoded
fonts, but such files will be never the part of OpTeX package. The
hyphenation patterns cannot work properly when such fonts are used.

<p CLASS=datum>(0018) -- P. O. 2020-05-25<p>
<hr>

<h2><a name="ul"></a>Marking parts of text</h2>

<p>We can use standard marking by {\it italic}, {\bf bold}, {\bi bold italic}
or {\em emphasized text}.
If you want to do something more special, then the following OPmac macros work
without any change in OpTeX:

<ul>
<li>\ul{text} for underlining text (splittable to more lines)
    like in the soul LaTeX package, see
    <a href="http://petr.olsak.net/opmac-tricks-e.html#soul">OPmac trick 0063</a>
<li>Overlining can be done by the same macro when \uline macro is redefined.
<li>Leterspacing referred in
    <a href="http://petr.olsak.net/opmac-tricks-e.html#soul">OPmac trick 0063</a>
    need not be done by this macro
    because we have more robust lettersacing implemented as font feature.
<li>\hyphenprocess from
    <a href="http://petr.olsak.net/opmac-tricks-e.html#hyphprocess">OPmac trick 0065</a>
    can be used to implement hyphenation feature to the \ul macro.
<li>Background colored (splitabble to more lines) text by
    <a href="http://petr.olsak.net/opmac-tricks-e.html#coltext">OPmac trick 0085</a>
    can be printed. Use \coltext\ColorA\ColorB{text}.
</ul>

<p CLASS=datum>(0044) -- P. O. 2021-02-08<p>
<hr>

<p CLASS="lmarg">Lists</p>

<h2><a name="multilist"></a>List items multi-numbered at arbitrary level</h2>

<p>We declare the \style m (multi-numbered) of the list. The items are
numbered similarly as sections, i.e. 1., 2. 2.1, 2.2, 2.2.1, 2.2.2, 2.2.3
etc. We create macro \keepstyle which propagates the current style to all
sub-levels. So:

<pre>
\begitems \style m \keepstyle  % prints:
* First                        % 1. First
* Second                       % 2. Second
  \begitems
  * Second-A                   %   2.1 Second-A
  * Second-B                   %   2.2 Second-B
  \enditems
* Third                        % 3. Third
\enditems
</pre>

<p>The implementation:

<pre>
\def\iprefix#1{}
\addto\_setlistskip{\ifnum\ilevel>1 \edef\iprefix{\iprefix.\the\itemnum}\fi}
\sdef{_item:m}{\iprefix.\the\itemnum. }
\def\keepstyle{\_defaultitem=\_printitem}
</pre>

<p>The \iprefix is saved at the start of \begitems (in the \_setlistskip macro)
and it is used in deeper levels of lists. There can be arbitrary nesting
levels.

<p CLASS=datum>(0047) -- P. O. 2021-02-17<p>
<hr>

<h2><a name="easylist"></a>Depth of the list given by number of *</h2>

<p>We daclere the macro \easylist which enables to give the list level
simply by the number of * used as a prefix. We need not to specify nesting
\begitems...\enditems. So, if we use the \style m and \keepstyle
from previous <a href="multilist">OpTeX trick 0047</a>, then the following
input:

<pre>
\begitems \easylist \style m \keepstyle
* First proposition.
** Interesting comment.
*** A note on the comment.
*** Another note.
**** By the way...
***** This is a subsub...-proposition.
* Let’s start something new...
\enditems
</pre>

<p>gives exactly the same output as documented at the page 2 of the LaTeX
package easylist (see texdoc easylist).

<p>The implementation:

<pre>
\def\countlist{\tmpnum=1 \countlistA}
\def\countlistA{\futurelet\next\countlistB}
\def\countlistB{\ifx\next\aast \ea\countlistC\else \ea\countlistD \fi}
\def\countlistC#1{\incr\tmpnum \countlistA}
\def\countlistD{%
   \ifnum\tmpnum&gt;\ilevel \fornum \ilevel..\tmpnum-1 \do{\_begitems\easylist}\else
   \ifnum\tmpnum&lt;\ilevel \fornum \tmpnum..\ilevel-1 \do{\_enditems}\fi\fi
   \_startitem}
\def\enditems{\fornum 1..\ilevel \do{\_enditems}}
</pre>

<p>Another application. We set given style for each used level:

<pre>
\everylist={\ifcase\ilevel\or \style X \or \style x \else \style - \fi}
\begitems \easylist
* Main one
* Main two
** sub-item
*** sub-sub-item
\enditems
</pre>

<p CLASS=datum>(0048) -- P. O. 2021-02-17<p>
<hr>


<p CLASS="lmarg">Verbatim</p>

<h2><a name="inttinoval"></a>Code blocks like in Markdown</h2>

<p>Code blocks are frequently used in Markdown. They are displayed as
an auto-sized, shaded, rounded-corner box around a word.
We can redefine the \_printinverbatim macro in order to do it:

<pre>
\def\_printinverbatim#1{%
   \ovalparams{\lwidth=0pt \lcolor=\LightGrey \fcolor=\LightGrey}%
   \inoval{\setbox0=\hbox{#1}\ht0=1.35ex \dp0=.15ex \box0}}
\activettchar`

This `text` is printed as a `code&amp; {block}`.
</pre>

<p><IMG SRC="../img/inttinoval.png" ALT="Code blocks" border=0>

<p>The \inoval macro is used for shaded rounded-corner box. The \vphantom{ly}
gives a strut inside the text. The height and depth of the text is set to
the constant values in order all ovals have the same height plus depth.

<p CLASS=datum>(0009) -- P. O. 2020-05-02<p>
<hr>

<h2><a name="keepverb"></a>Inline verbatim in macro parameters</h2>

<p>We know that inline verbatim in maro parameters does not work:

<pre>
\def\p#1{print: "#1"}
\activettchar`

\p{test: `\relax x~&amp;` fin.} % error (misplaced align tab)
</pre>

<p>The reason of this error: the parameter text is tokenized when the
parameter is read. The first ` is run after this parameter is completely read. It
changes catcodes but nothing is read directly from file at this time, so 
such catcode setting is ineffective.

<p>We know that the usage of \code{...} is 100% working, but we must to escape
each TeX sensitive character: \p{test: \code{\\relax x\~\&amp;} fin.}.

<p>There exist a method how to "protect" the macro parameter without
escaping the TeX sensitive characters. Use \verbi as a prefix before usage
of the macro:

<pre>
\def\verbi#1{\def\tmp{#1}\begingroup \verbC \verbG}
\def\verbii#1#2#{\def\tmp{#1#2}\verbiiA}
\def\verbiiA#1{\addto\tmp{{#1}}\begingroup \verbC \verbG}
\def\verbC{\catcode`\\=12 \catcode`\#=12 \catcode`\%=12 }
\def\verbG#1{\endgroup \tmp{\scantextokens{#1}}}

\activettchar`
\def\p#1{print: "#1"}

\verbi\p{aha `\relax!@#$%^&amp; uff~` mluff}

\verbii\table{cc}{ a &amp; `\table` \cr b &amp; `&amp;` }
</pre>

<p>The \verbii can be used before \table macro or similar macros 
where the second parameter is important.

<p>Implementaton note: We read the parameter first with category codes
set by \verbC. The \endgroup in the \verbG restores the original category
codes and the macro parameter is represented by \scantextokens{#1}. When
this parameter is processed then the current category codes are used again.
The \verbii macro read parameters like \verbii\table pxto10cm{cc}{...}.
This is the reason of the existence of the \verbiiA auxiliary macro. 

<p>This solution doesn't work in special cases when there are unpaired
braces {} in the verbatim parameter and with macros where the scanned
parameter is pre-processed. Only \code{...} is 100% working.

<p>Compare the complexity of the cprotect.sty LaTeX package with this 5-line
solution.

<p CLASS=datum>(0017) -- P. O. 2020-05-22<p>
<hr>

<p CLASS="lmarg">Graphics</p>

<h2><a name="gradients"></a>Color gradients</h2>

<p>We can use \input tikz and color gradients support from this package.
But there is another approach: create a color gradient in an interactive vector
editor (Inkscape, for example) and use it. You can create arbitrary rectangle
with color gradient in it and save such image to (say) my-gradient.pdf.

<p>Then you can draw a rule with 1pt thickness of this gradient by

<pre>
\hbox{\picwidth=\hsize \picheight=1pt \inspic{my-gradient.pdf}}
</pre>

<p>If you want to use gradients to another graphic objects, then it may be
more complicated. For example gradiented oval boundary with text in it:

<pre>
\newdimen\ovalw  \newdimen\ovalh
\ovalw=8cm \ovalh=15cm

\def\gradientoval{\clipinoval \dimexpr\ovalw/2 \dimexpr\ovalh/2 \ovalw \ovalh
   {\rlap{\picwidth=\ovalw \picheight=\ovalh \inspic{my-gradient.pdf}}%
   \raise5mm\hbox{\kern1mm
   \inoval[\roundness=4mm \fcolor=\White \lcolor=\White]
   {\raise\dimexpr\ovalh-1cm\hbox to\dimexpr\ovalw-1cm{}}}}}

\def\textingradientoval#1{\hbox{\rlap{\gradientoval}\kern5mm
   \raise\dimexpr\ovalh-1cm\vtop{\hsize=\dimexpr\ovalw-1cm\noindent #1}}}

\textingradientoval{\lorem[1]}
</pre>

<p>The \clipinoval is used first with my-gradient.pdf. Then a slightly
smaller white oval is drawn over it. Only the boundary remains visible.
Finally, the text is printed in it.

<p CLASS=datum>(0024) -- P. O. 2020-06-05<p>
<hr>

<h2><a name="carrows"></a>Curved arrows</h2>

<p>We prepare the macro

<pre>
\arrowcc x0 y0 {cx0 cy0 cx1 cy1} x1 y1 (dx1 dy1) {Text}
</pre>

<p>which draws the curve from x0 y0 to x1 y1 ended by arrow spike. The part
{cx0 cy0 cx1 cy1} can be empty, i. e. {}. The line is drawn in such case.
The numbers {cx0 cy0 cx1 cy1} gives the control points of a Bézier curve. At
the end of the arrow is printed the "Text" shifted by dx1 dy1. The numbers
cx0 cy0 cx1 cy1 x1 y1 are relative to the origin x0 y0. This origin is
relative to the current typesetting point. All numbers are in bp units by
default. The macro \arrowccparams can include the additional settings
(color, line width, etc.). The macro \arrowccspike includes the drawing of
the arrow spike and you can redefine it.

<pre>
\vglue5cm
\def\arrowccparams{1 0 0 rg 1 0 0 RG}  % red color is initialized

Pokus \arrowcc 0 10 {-30 20 -30 50} 20 50 (3 -3) {Text 1}
dále \arrowcc 0 -3 {} 40 -30 (3 -3) {Text 2}
a ještě \arrowcc 0 2 {10 20 20 30} 40 40 (3 -2) {Text 3}.
</pre>

<p>creates:

<p><IMG SRC="../img/sipky-ukazka.png" ALT="Code blocks" border=0>

<p>The implementation is exacltly the same as in
<a href="http://petr.olsak.net/opmac-tricks-e.html#sipky">OPmac trick 0062</a>
but the calculation of direction of the spikes is re-implemented using more
simple and straightforward lua code.

<pre>
\def\arrowccspike{2 0 m -5 2 l -5 -2 l h f}
\def\arrowcc #1 #2 #3 #4 #5 (#6)#7{%
   \if^#3^\preparerotdata(0 0) (#4 #5)\else \preparedirection #3 (#4 #5)\fi
   % x0 y0 {cx1 cy1 cx2 cy2} x1 y1 (dx1 dy1) {Text}
   \pdfsave\rlap{\pdfliteral{%
   .7 w \arrowccparams\space 1 0 0 1 #1 #2 cm 0 0 m
   \if ^#3^#4 #5 l \else #3 #4 #5 c \fi S
   1 0 0 1 #4 #5 cm  q \rotdata\space 0 0 cm \arrowccspike\space Q}%
   \if^#7^\else\pdfliteral{1 0 0 1 #6 cm}\hbox{#7}\fi}\pdfrestore
}
\def\preparedirection #1 #2 #3 #4 {\preparerotdata(#3 #4) }
\def\arrowccparams{}

\def\preparerotdata (#1 #2) (#3 #4){\edef\rotdata{\rotcm (#1 #2) (#3 #4)}}
\def\rotcm (#1 #2) (#3 #4){\directlua{%
   local x=(#3)-(#1)
   local y=(#4)-(#2)
   local norm = math.sqrt(x*x+y*y)
   if norm==0 then tex.print('1 0 0 1')
   else tex.print(string.format('\_pcent.3f \_pcent.3f \_pcent.3f \_pcent.3f',%
                                 x/norm, y/norm, -y/norm, x/norm))
   end
}}
</pre>

<p>The macro \rotcm takes vector (#3,#4)-(#1,#2) and prepares cm
matrix data for rotation in the direction of given vector.
The data are stored in \rotdata macro using \preparerotdata (for lines)
or \preparedirection (for Bézier curves). Then the \rotdata is used inside
\pdfliteral parameter.

<p CLASS=datum>(0037) -- P. O. 2021-02-05<p>
<hr>

<h2><a name="circletext"></a>Text around a circle</h2>

<p>We create a macro \circletext {radius}{angle}{TEXT}{correction} which
prints TEXT around a circle with given radius. First letter of the TEXT
starts at given angle. The fourth parameter declares a corrections between
letter pairs because the standard kerning table is deactivated when printing
around circle. The TEXT runs clockwise when the radius is positive (the
center of the circle is below the letters). When the radius parameter is
negative then TEXT runs anticlockwise and the center of the circle is above
the letters. The macro creates a typesetting material with zero dimensions,
the center of the circle is at the actual typesetting point. For example

<p><IMG SRC="../img/uni-ukazka.png" ALT="Code blocks" border=0>

<pre>
\hbox{%
\circletext {1.7cm} {212}  {{$\bullet$} UNIVERSITAS CAROLINA PRAGENSIS {$\bullet$}}
                           {\spaceskip=.5em \kpcirc TA{-.1}\kpcirc NA{-.05}}
\circletext {-1.7cm} {237} {Facultas MFF}
                           {\kpcirc Fa{-.1}}
}
</pre>

<p>The fourth parameter correction can include the declaration of word space
(using \spaceskip=...) and the space corrections between declared pairs of
letters using \kpcirc AB{num}: the \kern num (in em units) is inserted
between each pair of letters AB. Note that the example includes the
"composed object" $\bullet$. Such object must be enclosed by braces.

<p>The letterspacing can be set by \def\circletextS{\kern value}. The zero
letterspacing is set by default.

<p>The \circletext macro can be defined by

<pre>
\def\circletext#1#2#3#4{\hbox\bgroup
    \edef\tmpc{\expr{-57.295779/\bp{#1}}}% -(Pi/180)/R
    \setbox0=\hbox{\ifdim#1&lt;0pt X\fi}% lap letters by X height if R&lt;0
    \def\l{0}\baselineskip=#1 \advance\baselineskip by-\ht0 \lineskiplimit=-\maxdimen
    \edef\tmpa{\expr{\ifdim#1&lt;0pt \else-\fi90+#2}}%
    \def\tmpb{{}#3}\replstring\tmpb{ }{{ }}#4% spaces => {spaces}
    \pdfsave \pdfrotate{\tmpa}%
    \expandafter\circletextA\tmpb\relax
}
\def\circletextA#1{\ifx#1\relax\pdfrestore\egroup\ignorespaces\else
    \ifx^#1^\else \setbox0=\hbox{#1\circletextS}%
       \ismacro\l{0}\iffalse
          \edef\l{\expr{\l+\bp{.5\wd0}}}%
          \pdfrotate{\expr{\tmpc*\l}}%
       \fi
       \edef\l{\bp{.5\wd0}}%
       \vbox to0pt{\vss\hbox to0pt{\hss#1\hss}\null}%
    \fi
    \expandafter\circletextA\fi
}
\def\kpcirc#1#2#3{\replstring\tmpb{#1#2}{#1{\kern#3em}#2}}
\def\circletextS{}
</pre>

<p>The code from
<a href="http://petr.olsak.net/opmac-tricks-e.html#circletext">OPmac trick 0109</a>
is re-implemeted here. The calculation is done by \expr and \bp macros. The
\l macro means the lenght of typeset text and \tmpc is coefficinet which
converts such length to the angular measure in degrees.

<p CLASS=datum>(0038) -- P. O. 2021-02-05<p>
<hr>


<p CLASS="lmarg">Math</p>

<h2><a name="bbchar"></a>\bbchar from AMS fonts when Unicode math font is used</h2>

<p>When \fontfam[] is used and \noloadmath is not declared 
then a relevant math font from Unicode math fonts
is loaded too. The single font includes more math alphabets together: math
italics, roman, calligraphic, fractur, greek letters, bbchars etc.

<p>Maybe, your opinion about ideal black board letters (\bbchar's) is
influneced by traditional AMS fonts and it is different than the opinion of
font designer of the used Unicode math font (Latin Modern math font is
typical example of this case). Then you can return to the AMS \bbchars by
following code used <i>after</i> first the \fontfam[] command 
loads the Unicode math font.

<pre>
\addto\_normalmath{\_loadmathfamily 5 msbm }
\addto\_boldmath{\_loadmathfamily 5 msbm }
\def\bbchar{\fam5 \_rmvariables}
</pre>

<p>We need to add \_loadmathfamily 5 to \_normalmath and \_boldmath
in order to load 8 bit version of math fonts as family 5 (5 is the 
first unused math family when Unicode math font is loaded). 
Then we re-define \bbchar macro as
family5 selector and mathcodes of letters must be "normal" (not Unicoded) 
when this 8bit font is used (this is done by \_rmvariables macro).

<p CLASS=datum>(0001) -- P. O. 2020-04-09<p>
<hr>

<h2><a name="matrixx"></a>More comfortable writing of matrices</h2>

<p>It is quite strenuous to put the characters &amp; between every item in
the matrix. In particular, when we are writing a huge amount of matrices.
But we can simplify our writing (and reading the source text too) by 
\replstring macro. We create the \x macro which can be used as a prefix
before \matrix, \pmatrix etc. macros. If it is used then user can write
spaces instead &amp; characters.

<pre>
\def\x#1#2{\def\tmpb{#2}\replstring\tmpb{ }{&}\_ea#1\_ea{\tmpb}}

$$
  \x\pmatrix{x_1 x_2 x_3\cr 12 11 10} = \left[\x\matrix{12 11 10\cr y_1 y_2 y_3}\right]
$$
</pre> 

<p CLASS=datum>(0010) -- P. O. 2020-04-09<p>
<hr>


<h2><a name="biglr"></a>Bigger outer parentheses automatically set</h2>

<p>Sometimes we need to typeset something like f(b+((c+d)(e+f))\cdot g)
and we want to set outer parentheses bigger than the inner ones because this
is traditional typographical rule. We can write
$f\Bigl(b+\bigl((c+d)(e+f)\bigr)\cdot g\Bigl)$
in our TeX source but this makes the source less clear. The macro \biglr
defined here is able to set such task automatically. you can write:

<pre>
$\biglr f(b+((c+d)(e+f))\cdot g) \biglr$
</pre>

<p>All material between the couple of \biglr is scaned by TeX and the
appropriate \bigl, \bigr, \Bigl etc. are added before parentheses ()
automatically.

<pre>
\def\biglr#1\biglr{%
   \def\biglrL{}\tmpnum=0 \def\biglrM{0}%
   \def\tmpb{#1}\replstring\tmpb{(}{\biglrC(}\replstring\tmpb{)}{\biglrC)}%
   \ea\biglrA\tmpb\biglrC.%
}
\def\biglrA#1\biglrC#2{\addto\biglrL{#1}%
   \ifx.#2\tmpnum=\biglrM\relax \biglrL
   \else \addto\biglrL{\biglrC#2}%
         \ifx(#2\advance\tmpnum by1 \ifnum\biglrM&lt;\tmpnum \edef\biglrM{\the\tmpnum}\fi\fi
         \ifx)#2\advance\tmpnum by-1 \fi
         \ea \biglrA\fi}
\def\biglrC#1{\ifx(#1\advance\tmpnum by-1 \biglrD(\fi
              \ifx)#1\biglrE)\advance\tmpnum by1 \fi}
\def\biglrD{\ifcase\tmpnum \or\ea\bigl\or \ea\Bigl\or \ea\biggl \else \ea\Biggl\fi}
\def\biglrE{\ifcase\tmpnum \or\ea\bigr\or \ea\Bigr\or \ea\biggr \else \ea\Biggr\fi}
</pre>

<p>Note that the \biglr scanner is active only at outer level of braces {}. And it is
not usable when you are using fractions or other big objects inside
parentheses in display style.
Use \left, \right primitives in such situations.

<p CLASS=datum>(0026) -- P. O. 2020-06-30<p>
<hr>

<h2><a name="textinmath"></a>Text fonts in math mode</h2>

<p>When you write 13 or $13$ then the digits are (typically) rendered from
different fonts: from text font in first case and from math font in second
one. Sometimes you want to use only text fonts in both cases. Suppose that
you have a text font without visually compatible math font. Then you may
want to use a-z, A-Z, 0-9 and some other characters from text font in math
mode instead from math font. The following trick does this (compare
the mathastext.sty package used in LaTeX).

<p>We assume that the Unicode math font is loaded already and now, we want
to typeset characters mentioned above from text font in math mode. Try this:

<pre>
\loadmath{texgyretermes-math} % Math font is loaded: texgyretermes-math, just for testing
\fontfam[Heros]               % Text font is loaded: texgyreheros, just for testing

% Test:
Heros in text, 13, but $Termes-math, 13$. It is visually incompatible.

\_def\_xsetmathfamily#1 #2 #3{\_resizefont{#2}#3\_setmathfamily #1 #3}

\_addto\_normalmath{% This must be declared after Unicode math font is loaded
    \_xsetmathfamily    5 rm \_tenrm
    \_xsetmathfamily    6 it \_tenit
}%
\_addto\_boldmath{%
    \_xsetmathfamily    5 bf \_tenbf
    \_xsetmathfamily    6 bi \_tenbi
}
\def\_rmdigits    {\_umathrange{0-9}75\_digitrmO}
\def\_rmvariables {\_umathrange{A-Z}75\_ncharrmA \_umathrange{a-z}75\_ncharrma}
\def\_itdigits    {\_umathrange{0-9}76\_digitrmO}
\def\_itvariables {\_umathrange{A-Z}76\_ncharrmA \_umathrange{a-z}76\_ncharrma}

% Default settings:
\_normalmath              % reloads math fonts incuding families 5, 6.
\_rmdigits \_itvariables  % Upright digits, slanted variables

\_def\textcharsinmath #1#2 {\_ifx\_end#2\_else
   \_Umathcode `#1=#2 5 `#1\_relax \_ea\textcharsinmath\_fi}

% Characters !?*,.:;+-=()[]/&lt;&gt| are printed from math family 5, i.e. normal text font
\textcharsinmath !5 ?5 *2 ,6 .0 :6 ;6 +2 −2 =3 (4 )5 [4 ]5 /0 &lt;3 &gt;3 |0 .\end
\Umathcode `- = 2 5 "2212   % Minus in math mode creted by hyphen character
\Umathcode `\{ = 4 5 `\{    % \{ and \} must have mathcode from fam 5
\Umathcode `\} = 5 5 `\}
\Udelcode  `\{ = 1 `\{      % and delcode from fam 1 (math font)
\Udelcode  `\} = 1 `\}
\edef\{{\csstring\{}  \edef\}{\csstring\}}

% Test:
Heros in text and in math: $Heros-math: 13, M = -(3!) + y_5$.
</pre>

<p>The code above reloads the same Unicode math font but moreover, it loads the currently
used \rm and \it text fonts as math family 5 and 6. The digits are rendered
from family 5 and variables from family 6 instead from the math fonts. The
characters specified by \textcharsinmath, i.e. ! ? * , . : + - = ( ) [ ] &lt;
&gt; | \{ and \}, are printed from family 5 too.
Other math symbols are printed from original Unicode math font.

<p>If you have loaded a special text font by \font primitive, i.e.
\font\foo=something, then you can set this font as family 5 by

<pre>
\_addto\_normalmath{%
    \_setmathfamily    5 \foo
}
</pre>

<p>Note that \_setmathfamily (no \_xsetmathfamily) is used with only two
parameters: family number and the font switch.

<p CLASS=datum>(0027) -- P. O. 2020-07-09<p>
<hr>

<h2><a name="torighteq"></a>Equation marks in atypical cases</h2>

<p>We want to put equation marks \eqmark in more lines in display mode
when we are using macros not designed for such case.
For example in the lines of \case macro:

<pre>
$$ f(x) = \cases{0 &amp; for $x&lt;0$\toright\eqmark \cr
                 1 &amp; otherwise\toright\eqmark } $$
</pre>

<p>This puts the equation marks to the right margin in each line generated
by the \case macro. The \toright\eqmark is used here.

The \toright macro is based on the <a href="#setpos">OpTeX trick 0020</a>
where the \setpos and \posx macros are defined.

<pre>
\newcount\torightnum
\def\toright#1{\_incr\torightnum \setpos[tr:\the\torightnum]%
   \rlap{\kern-\posx[tr:\the\torightnum]\kern\hoffset\kern\hsize\llap{#1}}}
</pre>

<p>The parameter #1 is shifted to the right margin in the second run of TeX
because we need to know the absolute position of the current point and we
shift it to the right margin.

<p CLASS=datum>(0028) -- P. O. 2020-07-10<p>
<hr>

<h2><a name="addumathfont"></a>Loading additional Unicode math fonts</h2>

<p>Unicode math font should include all math characters needed in the document.
But it is not really true: try to load a Unicode math font using
\loadmath{math-font} followed by \input print-unimath.opm and you can see empty
slots. They are not supported by loaded math font.

<p>Maybe, another Unicode math font supports another slots. You can combine
more than one math font in single document. For example, you have loaded
Garamond-Math font and you have found that \triangleq isn't supported. Then you
can load additional Unicode math font by \addUmathfont and you can
re-declare \triangleq in order this additional font is used for such
character. Example:

<pre>
\fontfam [EBGaramond]  % Garamond family including Garamond-Math is loaded
\addUmathfont \stix {[STIXMath-Regular]}{} {}{} {} % additional font STIX loaded
\resetUmathchar \stix \triangleq  % \triangleq will use STIX

Test: $a \triangleq b$. % All is in Garamond only \triangleq in STIX.
</pre>

<p>You can load more than one additional Unicode math font (use more than
one \addUmathfont command). Each additional font declares a new math-font
family (its name is given in the first parameter) and you can use this name for
re-declaring math characters. You can use \resetUmathchars (instead of
\resetUmathchar) in order to re-declare more than one math character.
The list of character sequences must be terminated by colon in such case.
For example:

<pre>
\resetUmathchars \stix \stareq \triangleq \veeeq \wedgeq ;
</pre>

<p>The implementation of \addUmathfont, \resetUmathchar and \resetUmathchars
macros follows:

<pre>
\def\resetUmathchar #1#2{% #1: fam, #2 \mathsequence
   \tmpnum=#2 \divide\tmpnum by16777216 \multiply\tmpnum by16777216
   \tmpnum=\numexpr #2-\tmpnum \relax
   \global\Umathcharnumdef #2=\numexpr 16777216*#1 + \tmpnum\relax
   \setUmathcode#2
}
\def\setUmathcode#1{% #1 \mathsequence
   \tmpnum=#1 \divide\tmpnum by1048576 \multiply\tmpnum by1048576
   \global\Umathcodenum\numexpr #1-\tmpnum =#1\relax
}
\def\resetUmathchars #1{\def\tmp{\resetUmathchar#1}\xargs\tmp}

\def\addUmathfont #1#2#3#4#5#6{% #1: fam (will be set), #2#3: normal font, #4#5: bold font
   \ifx\_ncharrmA\undefined \errmessage{basic Unicode math font must be loaded first}\fi
   \global\advance \famaddress by1
   \global\chardef #1=\famaddress
   \global\addto\_normalmath{\_corrmsize#6 \_loadumathfamily #1 {#2}{#3} }%
   \ifx\relax#4\relax
      \global\addto\_boldmath{\_corrmsize#6 \_loadumathfamily #1 {#2}{embolden=1.7;} }%
   \else
      \global\addto\_boldmath{\_corrmsize#6 \_loadumathfamily #1 {#4}{#5} }%
   \fi
   \_normalmath
   \wterm{MATH-FONT: added #1=\the#1, normal: "#2", \ifx"#4"\else bold: "#4"\fi}
}
\newcount\famaddress  \famaddress=100
</pre>

<p>The \addUmathfont has six parameters:
family-name {normal-font}{features} {bold-font}{features} {factor}.
If "bold-font" is empty then faked bold constructed from normal-font is used.
The factor is decimal number for size corrections. If it is empty then factor=1.
The math families are allocated from 101, 102 etc., i.e. macro programmer can
use the numbers 5..99 for direct addressing (note that 0..4 are reserved by
TeX and OpTeX).

<p>The \resetUmathchar re-sets the appropriate Umathcode too (using
\setUmathcode macro).

<p>This trick was inspired by <a
href="https://tex.stackexchange.com/questions/573046/">a question at
StackExchange</a>, but I recommend to use my answer (wipet's answer) in this
case becuase combination of basic equal sign from Garamond with other equal
signs from STIX doesn't look good in single formula.

<p CLASS=datum>(0030) -- P. O. 2020-12-02<p>
<hr>

<h2><a name="dots"></a>Intelligent \dots like in AMSTeX</h2>

<p>AMSTeX provides \dots macro which works by the context. If it is surrounded
by symbols like + - = then it works like \cdots, if it is surrounded by
comma or similar symbols then it works like \ldots.
The <a href="http://petr.olsak.net/opmac-tricks-e.html#dots">OPmac trick 0084</a>
shows one implementation of this feature, but it works only in
non-Unicode math. So, we show another solution.

<pre>
\def\declbasemathchars#1{\foreach#1\do{\sxdef{dots:\meaning##1}{}}}
\def\dots{\relax \ifmmode \ea\specdots \else \_dots \fi}
\def\specdots{\futurelet\next\specdotsA}
\def\specdotsA{\ifcsname dots:\meaning\next\endcsname \ldots
   \else \ischaracter\next \iftrue \cdots
   \else \ea\specdotsB\scantextokens\ea{\meaning\next}\sepU\Umathchar\sepU\end \fi\fi}
\def\specdotsB#1\Umathchar#2\sepU#3\end{\ifx^#1^\specdotsC#2\sepU \else \ldots \fi}
\def\specdotsC"#1"#2"#3\sepU{%
   \ifcase#1 \ldots\or \cdots\or \cdots\or \cdots\or \cdots\or \cdots\else \ldots \fi}
\def\ischaracter#1\iftrue{\ea\ischaracterA\scantextokens\ea{\meaning#1}character {}\end}
\def\ischaracterA#1character #2#3\end{%
   \ifx\relax#2\relax \cs{iffalse\ea}\else \cs{iftrue\ea}\fi}

\declbasemathchars{, . ; :}

% Test:
$a_1,\dots,a_n$\quad $a_1+\dots+a_n$
\bye
</pre>

<p>The macro \dots is re-defined here in math mode. It reads the following
token and does \cdots or \ldots. If the following token is a single letter
then it uses \ldots. If the following token is a single character not
listed in the \declbasemathchars parameter then it uses \cdots. If it is listed
in \declbasemathchars paremater then it uses \ldots. If the next token is
a control sequence declared by \Umathchardef then it uses \cdots for classes
Op, Bin, Rel, Open, Close and \ldots for other classes. In other cases,
it uses \ldots.

<p>The \declbasemathchars can be used more than once, the list of declared
characters are appended when second and more \declbasemathchars is used.

<p CLASS=datum>(0045) -- P. O. 2021-02-12<p>
<hr>

<p CLASS="lmarg">Tables</p>

<h2><a name="colortab"></a>Colored cells in the table</h2>

<p>We create the macro \colortab which can be used in \thistable
declaration. When this macro is applied then tha background of each cell
can be cloered by chosen color. If
the first item in the cell data is color switcher then this color is used
for the background of the cell. For example:

<pre>
   ... &amp; \Blue Text &amp;        ... % blue background and black text 
   ... &amp; \Green \Red  Text &amp; ... % green background and red text 
   ... &amp; \relax \Blue Text &amp; ... % blue text and default background 
</pre>

<p>The color of the background will stretch as spaces in the common cells in
normal table, i.e. C declarator means that colored space will stretch from
both sides, L declarator means right stretching and R declarator means left
stretching. The spaces from \tabiteml and \tabitemr are colored too.

<p>If \cellcolor sequence is set by \let to the color (example
\let\cellcolor=\Yellow) then this color is used as default background.
If the \cellcolor is undefined then default background is transparent.

<p>You can insert the white space between columns by nonzero \tabskip and
you can insert the white space between lines by \noalign{\kern...}. Example:

<pre>
\thistable={\colortab              % colored cells activated
            \tabstrut={\lower4pt\vbox to15pt{}}        % lines dimensions
            \tabskip=2pt \everycr={\noalign{\kern2pt}} % spaces between cells
            \let\cellcolor=\Yellow % default background color
           } 
\table{clr}{first item      &amp; second &amp; \Blue \White third item \cr 
            next long item  &amp; \Red X &amp; \Green       YES }
</pre>

creates the table:

<p><IMG SRC="../img/tab4-ukazka.png" ALT="Table example" border=0>

<p>Implementation: 

<pre>
\def\tabdC{\futurelet\next\setcellcolor##\end\hfil\hfil} 
\def\tabdL{\futurelet\next\setcellcolor##\end\relax\hfil} 
\def\tabdR{\futurelet\next\setcellcolor##\end\hfil\relax}
\def\tabdP#1{\futurelet\next\setcellcolor##\end\vtop
    {\hsize=#1\relax \baselineskip=\normalbaselineskip
     \lineskiplimit=0pt \noindent\tmp\_unsskip\lower\dp\_tstrutbox\hbox{}}}
\def\colortab{\tablinespace=0pt \let\_paramtabdeclarep=\tabdP
   \let\_tabdeclarec=\tabdC \let\_tabdeclarel=\tabdL \_let\_tabdeclarer=\tabdL}
\def\setcellcolor{%
   \ifx\next\_setcolor \expandafter\setcellcolorC\else \expandafter\setcellcolorD\fi} 
\def\setcellcolorC\_setcolor#1#2\end#3#4{% 
   \ifx#3\vtop \def\tmp{#2}%
      \setbox0=\hbox{\the\tabiteml\vtop{\localcolor#4}\the\tabitemr}%
      \the\tabstrut {\localcolor\_setcolor{#1}\vrule width\wd0}\kern-\wd0 \box0
   \else
      \setbox0=\hbox{{\the\tabiteml\localcolor#2\_unsskip\the\tabitemr}}% 
      {\localcolor\_setcolor{#1}%
       \the\tabstrut\leaders\vrule\hskip\wd0 \ifx#3\hfil plus1fil\fi}% 
      \kern-\wd0 \box0 
      \ifx#4\hfil 
      {\kern-.2pt \localcolor\_setcolor{#1}\leaders\vrule\hskip.2pt plus1fil}\fi
   \fi 
} 
\def\setcellcolorD{\ifx\cellcolor\undefined \let\next=\setcellcolorN 
   \else \def\next{\_ea\_ea\_ea\setcellcolorC\cellcolor}% 
   \fi \next 
} 
\def\setcellcolorN#1\end#2#3{#2\tabiteml{\localcolor#1\unskip}\tabitemr#3}

\def\multispanc#1#2#3{\multispan{#1}% 
   \_ea\_ea\_ea\cellcolexp#2#3\end\hfil\hfil\ignorespaces} 
\def\cellcolexp{\futurelet\next\setcellcolor} 
</pre>

<p>The \setcellcolor macro scans the first token from the cell data. The
macro works in declaration part of the \halign, so the first token is
scanned as the first unexpandable token after expansion. This token is
\_setcolor when color macro is presented here. If this is true then the
\setcellcolorC macro is executed, #1 is the \_setcolor parameter
#2 is the text of the item, #3 and #4 include the
message about the align style. This macro measures the cell text in the box0
and does the colored backround by \leaders. If the first token isn't \global
then the macro \setcellcolorD decides if the \cellcolor is defined. If it is
true then \setcellcolorC is execuded (with patrially expanded \cellcolor as
parameter). Else the \setcellcolorN is executed. This macro prints no
background.

<p>The \multispanc Num \Color {text} can be used for multispan cells, see
<a href="http://petr.olsak.net/opmac-tricks-e.html#multispanc">OPmac trick 103</a>.

<p CLASS=datum>(0004) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="colorlin"></a>Colored lines in the table</h2>

<p>We can see the trend to use colored tables like this:

<p><IMG SRC="../img/tab2-ukazka.png" ALT="Table example" border=0>

<p>The table above can be created by the \table macro from OpTeX:

<pre>
\thistable={\tabiteml={\quad}\tabitemr={\quad}}
\frame{\table{llllll}{\crx
  aa &amp; bb &amp; cc &amp; dd &amp; ee &amp; ff \crx
  gg &amp; hh &amp; ii &amp; jj &amp; kk &amp; ll \crx
  mm &amp; nn &amp; oo &amp; pp &amp; qq &amp; rr \crx
  ss &amp; tt &amp; uu &amp; vv &amp; ww &amp; xx \crx
  ab &amp; cd &amp; ef &amp; gh &amp; ij &amp; kl \crx
  mn &amp; op &amp; qr &amp; st &amp; uv &amp; wx}}
</pre>            

<p>We need to define the \crx macro which inserts the grey rule before each
odd line into the vertical list:

<pre>
\newcount\tabline  \tabline=1 
\def\crx{\crcr \ifodd\tabline \colortabline \else\noalign{\hrule height0pt}\fi 
         \global\advance\tabline by1 } 
\def\colortabline{\noalign{\localcolor\LightGrey 
   \hrule height\ht\strutbox depth\dimexpr\dp\strutbox +2\tablinespace\relax 
   \kern-\dimexpr\ht\strutbox+\dp\strutbox +2\tablinespace}} 
</pre>

<p>The \tabline counter counts the lines in the table and inserts the
grey backgroud for each odd \tabline. The last line must not be terminated
by \crx macro.

<p CLASS=datum>(0005) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="booktabs"></a>Tables like in booktabs package</h2>

<p>The orthodox advocates of LaTeX booktabs package don't like the table
formats from the example above and they point out that I am loser because I
don't know that the vertical rules in the table are out. Only horizontal
rules are allowed but not double rules. And less rules is better than more.
They have the following example in the documentation:

<p><IMG SRC="../img/tab3-ukazka.png" ALT="examle of table" border=0>

<p>we can create such table by OpTeX and without booktabs package:

<pre>
\thistable={\tabiteml={}\tabitemr={}\rulewidth=.2pt}
\table{l(\quad)lr}{                           \crtop 
  \mspan2[c]{Item}         &amp;                  \crlp{1-2} 
   Animal    &amp; Description &amp; \quad Price (\$) \crmid 
   Gnat      &amp; per gram    &amp;      13.65       \cr 
             &amp; each        &amp;       0.01       \cr 
   Gnu       &amp; stuffed     &amp;      92.50       \cr 
   Emu       &amp; stuffed     &amp;      33.33       \cr 
   Armadillo &amp; frozen      &amp;       8.99       \crbot} 
</pre>

<p>We only need to define \crtop, \crmid, \crbot macros:

<pre>
\def\crtop{\crcr \noalign{\hrule height.6pt \kern2.5pt}} 
\def\crbot{\crcr \noalign{\kern2.5pt\hrule height.6pt}} 
\def\crmid{\crcr \noalign{\kern1pt\hrule height.4pt\kern1pt}} 
</pre>

<p>We need to set default rulewidth for this table to .2pt
(it is generated by \crlp{1-2}). Other rules have explicitly declared 
thickness.
We have to remove the spaces left in the first cell and right in
the last cell because the rules have to be aligned with the text. This is a
reason why the \tabitemr and \tabiteml are empty. The space between first
and second column is created by (\quad) in the declaration. The same space
before third column is caused by \quad before "Price". 

<p CLASS=datum>(0007) -- P. O. 2020-04-10<p>
<hr>

<h2><a name="decdigits"></a>Decimal digits aligned by the decimal point</h2>

<p>We declare new column letter N with numeric parameter: it gives the
maximal number of the digits used after the decimal point in the column. 
Table items can be in the form "xxx.xx" or ".xxx" or "xxx.". All these
variants are aligned by the decimal point. The deciaml point itself is
printed by the \decimalpoint macro, which can be defined as period or 
as comma (comma is used in Czech traditional typography for decimal numbers).
The latest form "xxx." is aligned too but the decimal point is not printed.
If the table item does not have any decimal point (for example it is the
title of the column) then the text is centered.

<pre>
\def\_paramtabdeclareN#1{\the\tabiteml\hfil\adigit{#1}##.\relax\the\tabitemr} 
\def\adigit#1#2.#3{\ifx\relax#3\hfil#2\_unsskip\hfil \else
    \tmpdim=.5em \tmpdim=#1\tmpdim $#2$%
    \_ea \ifx.#3\relax\phantom\decimalpoint \else \decimalpoint \fi
    \_ea \adigitA\fi #3%
}
\def\adigitA#1.\relax{\hbox to\tmpdim{$#1$\hss}} 

% test:

\table{r N3 l}{
       &amp; results &amp; \crl
   aha &amp;   1.24  &amp; uff \cr
   uha &amp;    .123 &amp; mm  \cr
    nn &amp;  24.42  &amp; rr  \cr
     p &amp;   2.    &amp; r   \cr
     q &amp;    .24  &amp; s   }
</pre>

<p>The N declararor runs \adigit macro. This macro reads the item data until
decimal point is found. The hidden decimal point is in the right part of
declaration, so we are sure that the scanning of the parameter finishes.
If this compensatory decimal point is scanned (i.e. no decimal point is in the
item data, #3 is \relax) then we write the text centered. Else we write left
part of the number, \decimalpoint (or \phantom\decimalpoint if no digits
follows) and the rest is printed in the box with fixed width given by the 
number of digits declared in N parameter. 

<p>If you don't want to specify the maximal number of digits, you can
declare D column declarator (without parameter) and use the \eqbox macro
from OpTeX.

<pre>
\def\_tabdeclareD{\the\tabiteml\hfil\adigitD##.\relax\the\tabitemr} 
\def\adigitD#1.#2{\ifx\relax#2\hfil#1\_unsskip\hfil \else
    $#1$%
    \_ea \ifx.#3\relax\phantom\decimalpoint \else \decimalpoint \fi
    \_ea \adigitAD\fi #3%
}
\def\adigitAD#1.\relax{\eqbox l[D:\the\tabnum/\the\colnum]{$#1$}} 

\newcount\tabnum
\everytable{\global\advance\tabnum by1}
</pre>

<p>We must to specify the label for \eqbox uniquely in whole document. So we
have to set numbers to each table and use the label in the form
D:tablenum/colnum. Note that the column number \colnum is calculated by the 
\table macro and it is available for each column used in this macro. 

<p CLASS=datum>(0015) -- P. O. 2020-05-20<p>
<hr>

<h2><a name="longtable"></a>Long table across multiple pages</h2>

<p>The \table macro runs \halign primitive inside \vbox. This is reason why
it is unbreakable to multiple pages. But you can deactivate this \vbox. Suppose
that you have a lot of lines like this:

<pre>
\def\ltable{\bgroup \let\_tablebox=\egroup \table} % the \vbox is deactivated

\ltable{|c|c|}{data &amp; data \cr 
               data &amp; data \cr 
      ... much more &amp; data ... \cr} 
</pre>

<p>Now, the \halign can work in main vertical mode and its lines are breakable to
more pages. But you can see more problems. If the \table is in main vertical
mode, then all lines are at the left margin of the page box. Maybe, you want
to see them in the center. This can be done by:

<pre>
\thistable{tabskipl=0pt plus1fil \tabskipr=\tabskipl}
\ltable to\hsize {|c|c|}{data &amp; data \cr 
                         data &amp; data \cr 
                ... much more &amp; data ... \cr} 
</pre>

<p>OK, the table is in the center. But \crl does not do what we want. We can use
\crli instead it. If there is \crli at each line, then we see next problem.
The horizontal rule is at the bottom of the page but not at the top of next
page. You can re-define \crli like this:

<pre>
\thistable{\tabskipl=0pt plus1fil \tabskipr=\tabskipl
           \def\crli{\_crli \noalign{\penalty0\kern-.4pt}\_crli\noalign{\nobreak}}}
\ltable to\hsize{|c|c|}{\crli
                  data &amp; data \crli
                  data &amp; data \crli 
         ... much more &amp; data ... \crli} 
</pre>

<p>The trick is based on the fact, that there are two horizontal rules (one
over another) between each lines. If a page break occurs (at \penalty0)
then one horizontal rule is at the bottom and second one at the top of next
page. 

<p>The tricks above are only very simple examples of long tables. If you
need something more smart then you can use fixed witdh of table items and
each line is one \hbox. You need not to use \halign. Or you can use \eqbox
from OpTeX. Or you can resample the boxes created by \halign. This
last approach allows to repeat a table header at the top of each page again:

<pre>
\def\longtable#1#2{\goodbreak \bgroup \tablinespace=0pt \let\_zerotabrule=\empty 
   \setbox0=\table{#1}{\strutT\relax #2} 
   \setbox1=\vbox{\unvbox0 \setbox2=\vbox{}\revertbox} 
   \setbox2=\vbox{\unvbox2 \global\setbox4=\lastbox\unskip \global\setbox5=\lastbox\unskip}
   \whatfree4 \advance\tmpdim by-.8pt \ifdim\tmpdim&le;\baselineskip \vfil\break \fi 
   \offinterlineskip \crule\center4\crule\center5 \printboxes 
   \center5\crule \egroup \goodbreak 
}
\def\whatfree#1{\tmpdim=\vsize \advance\tmpdim by-\pagetotal 
   \advance\tmpdim by-\prevdepth \advance\tmpdim by-.4pt 
   \advance\tmpdim by-\ht#1 \advance\tmpdim by-\dp#1 \advance\tmpdim by-\ht5 } 
\def\revertbox {\setbox0=\lastbox\unskip 
   \ifvoid0 \else \global\setbox2=\vbox{\unvbox2\box0} \ea\revertbox\fi } 
\def\printboxes{\setbox2=\vbox{\unvbox2 \global\setbox0=\lastbox\unskip} 
   \ifvoid0 \else \whatfree0 
      \ifdim\tmpdim&le;0pt \center5\crule\vfil\break \crule\center4\crule\center5 \fi 
      \center0 \nobreak \printboxes \fi } 
\def\crule{\centerline{\hbox to\wd4{\hrulefill}}\nobreak} 
\def\center#1{\centerline{\copy#1}\nobreak} 

\def\strutT {\vrule height1.8em depth.8em width0pt} % strut for the title

\longtable {|c|c|c|}{ head1 &amp; head2 &amp; head22 \cr % title 
                                             \tskip5pt
                      data2 &amp; data2 &amp; data2 \cr
                      data3 &amp; data3 &amp; data3 \cr
                      data4 &amp; data4 &amp; data4 \cr 
                       data &amp; data  &amp; data \cr 
              ... much more &amp; data  &amp; data ...} 
</pre>

<p>The head1 , head2 and head22 is repeated with rules above and below this
head at the top of each page. The \tskip is mandatory here and it separates
the bottom rule of the head from the data. This solution is copied from
OPmac trick 0024.


<p CLASS=datum>(0016) -- P. O. 2020-05-20<p>
<hr>

<h2><a name="tablevcent"></a>Vertically centered paragraphs in table</h2>

<p>The p declarator in the \table macro creates paragraphs in \vtop. It
means that first line of all paragraphs in one table row is vertically
aligned. Maybe, you want to set vertically alignment to center or to the last
line. The following testing code shows one approach:

<pre>
\def\vcent{\def\_vtop##1{$\vcenter{\noindent\raise\ht\_tstrutbox\hbox{}##1}$}}
\def\vbot{\def\_vtop##1{\vbox{\noindent\raise\ht\_tstrutbox\hbox{}##1}}}

\table{|p{1.5cm}|p{4cm}|}{ % top alignment (default)
 \crl
 d f g fd s f h d d s r df g h jj f d sd f d f g g t f di ejb  &amp;
 ff h hjs hjs chjds js sjd fgh fshs gf sfhs fh ss shfs fs
 \crl
}

\table{|(\vcent)p{1.5cm}|:(\vcent)p{4cm}|}{ % vertically centered paragraphs
 \crl
 d f g fd s f h d d s r df g h jj f d sd f d f g g t f di ejb  &amp;
 ff h hjs hjs chjds js sjd fgh fshs gf sfhs fh ss shfs fs
 \crl
}
</pre>

<p>The \_vtop used in the p declarator is locally redefined to \vcenter. This is
done by (\vcent) prefixed before each p declarator. We must to use column
boundary declarator ":" in order to apply the \vcent to the following p column.
The \vbot macro can be used instead \vcent: the paragraphs will be
vertically aligned to the bottom.
The tabstrut must be added to the first line of the paragraphs. This is done
in \vcent or \vbot macros.

<p>The alternative is:

<pre>
\thistable{\vcent} \table{|p{1.5cm}|p{4cm}|}{...}
</pre>

<p>Another alternative is to declare new column declatator,
for example "V":

<pre>
\_def\_paramtabdeclareV#1{\_the\_tabiteml
   $\_vcenter{\_hsize=#1\_relax \_baselineskip=\_normalbaselineskip
   \_lineskiplimit=0pt \_noindent \raise\ht\_tstrutbox\hbox{}##\_unsskip
   \_ifvmode\_vskip\_dp\_tstrutbox
   \_else\_lower\_dp\_tstrutbox\_hbox{}\_fi}$\_the\_tabitemr}

\table{|V{1.5cm}|V{4cm}|}{...}
</pre>

<p CLASS=datum>(0023) -- P. O. 2020-06-01<p>
<hr>

<h2><a name="dnaligned"></a>The decimal point aligned in the table</h2>

<p>We create table column declarator Nn which can be used for decimal
numbers aligned by decimal point.

<pre>
\table{|c|Nn|}{\crl
   first:   &amp; 23433.1       \cr
   second:  &amp;    55.131415  \crl
}
</pre>

<p>In fact, there are two clumns N and n with following declarations:

<pre>
\def\_tabdeclareN{\the\tabiteml \hfil \scannum ##\_unsskip}
\def\_tabdeclaren{##\_unsskip \hfil \the\tabitemr}

\def\scannum#1 {\isinlist{#1}.\iftrue \ea\scannumA \else \ea\scannumB\fi #1\relax}
\def\scannumA#1.#2\relax{#1&amp\decimaldot#2}
\def\scannumB#1\relax{#1&amp}
\def\decimaldot{.}
</pre>

<p>First column N is right aligned and second colum n is left aligned. The
first column runs the scanner \scannum which reads the number separated by
space. It means that we must write space after numbers and before &amp; or \cr.

<p>There exists more powerfull macro \num which can be used in tables
too, see <a href="#num">OpTeX trick 0040</a>.

<p CLASS=datum>(0039) -- P. O. 2021-02-06<p>
<hr>

<h2><a name="tnote"></a>Table notes</h2>

<p>We create the macro \tnote{text} which can be used in tables. Each
occurrence prints only a mark in the form ^a, ^b, etc. and saves {text} into
the memory. When the table is printed then user write \tnoteprint
and the marks are repeated again with the appropriate texts. This is similar
as footnotes, but works locally for each table.

<pre>
\newcount\tnotenum
\def\tnotelist{}
\def\tnote#1{\incr\tnotenum $\Red^{\rm\_athe\tnotenum}$\global\addto\tnotelist{{#1}}}
\def\tnoteprint{\par\noindent \tnotenum=0
   \ea\foreach\tnotelist \do{\advance\tnotenum by1 $\Red^{\rm\_athe\tnotenum}$##1 }\par
   \global\tnotenum=0 \gdef\tnotelist{}%
}

%test:
\table{|c|c|}{\crl
  m\tnote{meters}      & s\tnote{seconds} \crl
  kg\tnote{kilograms}  & A\tnote{ampers} \crl
}
\tnoteprint
</pre>

<p>The format of \tnoteprint is single paragraph with \noindent and with note
marks in \Red. You can create a different \tnoteprint macro with different
formating, of course.

<p CLASS=datum>(0046) -- P. O. 2021-02-14<p>
<hr>

<p CLASS="lmarg">Text blocks</p>

<h2><a name="greyblock"></a>Text blocks with grey background splittable to more pages</h2>

<p>We implement another design of \begblock...\endblock than the default from OpTeX.
The text blocks will have a grey background. They can split into more pages. The
grey background continues to the next pages in this case. The main issue of
the implementation is this splitting problem:

<pre>
\newcount\blocklevel  % nesting level of blocks
\def\begblock{\par\bgroup
   \advance\blocklevel by1 \advance\leftskip by\iindent \rightskip=\leftskip
   \medskip
   \pdfsavepos \ea\_wref\ea\Xblock\ea{\ea{\the\blocklevel}B{\the\pdflastypos}}
   \nobreak \medskip
}
\def\endblock{\par\nobreak\medskip
   \pdfsavepos \ea\_wref\ea\Xblock\ea{\ea{\the\blocklevel}E{\the\pdflastypos}}
   \medskip \egroup
}
\refdecl{%
   \def\Xblock#1#2#3{\ifnum#1=1 \edef\tmp{frm:\ea\ignoresecond\_currpage}^^J
      \unless\ifcsname \tmp \endcsname \sxdef{\tmp}{}\fi^^J
      \sxdef{\tmp}{\cs{\tmp}#2{#3}}\fi}
}
\newdimen\frtop \newdimen\frbottom % positions of top and bottom text on the pages
\def\frcolor{.8 g } % light grey -- color of blocks.
\pgbackground={%
   \slet{tmp}{frm:\the\pageno}
   \ifx\tmp\relax \def\tmp{}\fi
   \frtop=\dimexpr \pdfpageheight-\voffset+\smallskipamount\relax
   \frbottom=\dimexpr\pdfpageheight-\voffset-\vsize-\medskipamount\relax
   \ifx\frnext y \edef\tmp{B{\number\frtop}\tmp}\global\let\frnext n\fi
   \ea\printframes \tmp B{0}E{\number\frbottom}
   \ifx\frameslist\empty \else
   \pdfliteral{q \frcolor 1 0 0 1 0 \bp{-\pdfpageheight} cm \frameslist Q}\fi
}
\def\printframes B#1#2E#3{\ifnum#1=0 \else
   \printframe {\hoffset}{#3sp}{\_xhsize}{\ifnum#1=-1 \number\frtop\else#1\fi sp-#3sp}
   \ifx^#2^\else \global\let\frnext=y \let\printframes=\relax \fi
   \expandafter\printframes\fi
}
\def\frameslist{}
\def\printframe #1#2#3#4{\edef\frameslist{\frameslist
    \bp{#1} \bp{#2} \bp{#3} \bp{#4} re f }%
}
</pre>

<p>The main idea of the implementation. The \begblock writes its vertical
position to the .ref file in the format \Xblock{level}B{position} using
\pdfsavepos and \pdflastypos. The \endblock writes analogical information in the format
\Xblock{level}E{position}. We restore this information (only first nesting level)
from the .ref file like

<pre>
\def\frm:gpageno{B{pos}E{pos}B{pos}E{pos}...B{pos}E{pos}}
</pre>

<p>for each page number gpageno. The grey rectangles are drawn in the
\pgbackground when output routine is processed in the second TeX run.
This is done by

<pre>
\printframes B{pos}E{pos}...B{pos}E{pos}B{0}E{bottom-pos}
</pre>

<p>This macro reads B{}E{} in pairs in a loop and creates the frame for each
pair. When B{0}E{bootom-pos} is read, the loop is finished and the last
frame is not created. This is "normal" behavior when all blocks begin and
end on the same page. If we have an opened block at a page (but not closed),
then the data looks like

<pre>
\printframes B{pos}E{pos}...B{pos}B{0}E{bottom-pos}
</pre>

<p>The last pair B{pos}#2E{bottom-pos} is processed now (#2 is ignored) and the
status about the continued block is saved as \frnext=y. Then the data
of the next page looks like B{top-pos}E{pos}...B{0}E{pos}.

<p>You can test it:

<pre>
\lipsum[1]
\begblock
  \lipsum[2-3]
\endblock
\lipsum[4-5]
</pre>

<p>and run OpTeX twice. See also the next OpTeX trick.

<p CLASS=datum>(0031) -- P. O., 2021-01-13<p>
<hr>

<h2><a name="blocksum"></a>The checksum of text blocks</h2>

<p>We get the right position of the grey background of text blocks (from
the previous trick) after the second run of OpTeX. We add another code to
the code of the previous trick which prints the "WARNING: Rerun to get text
blocks right" whenever the block positions are changed and we need the second
TeX run.

<p>First of all, we need to add the

<pre>
\global\advance\blocksumcheck by\pagetotal
</pre>

<p>to both macros \begblock and \endblock (for example just before \pdfsavepos).
Then we can add the following code:

<pre>
\newcount\blocksumcheck
\def\_byehook{%
   \immediate\_wref\def{\string\blocksumsaved{\the\blocksumcheck}}
   \ifx\blocksumsaved\undefined \def\blocksumsaved{0}\fi
   \ifnum\blocksumsaved=\blocksumcheck \else \opwarning{Rerun to get text blocks right}\fi
   % these lines are copied from original \_byehook macro:
   \_ifnum\_unresolvedrefs>0 \_opwarning{Try to rerun to get references right}\_fi
   \_ifx\_initunifonts\_relax \_relax\_else \_opwarning{Unicode font was not loaded}\_fi
}
</pre>

<p>The checksum \blocksumcheck is calculated using \pagetotal of block
positions. After that, it is checked with the \blocksumsaved
(from previous TeX run) and finally, a new value of \blocksumcheck
is saved to the .ref file as \def\blocksumsaved{value of \blocsumcheck}.
The warning is printed if \blocksumsaved is not equal to \blocsumcheck.

<p>Notices: 1. The arithmetic overflow (when \advance\checksum by\pagetotal) does
not matter: the register skips to negative values and the sum is calculated
again. 2. The exact position values calculated from \pdfsavepos \pdflastypos are
unused because we can compare them reasonably only after the third TeX run.

<p CLASS=datum>(0032) -- P. O., 2021-01-13<p>
<hr>

<h2><a name="blockoval"></a>Text blocks in ovals</h2>

<p>The trick 0032 above (text blocks splitting to more pages) should be
modified with respect to various different designs. The example below puts
these blocks to yellow ovals with red borders.

<p>We have to modify the \frcolor macro:

<pre>
\def\frcolor{1 1 0 rg 1 0 0 RG } % yellow background, red borders
</pre>

<p>and the \printframe macro in order to print the oval with desired sizes.
The diameter or rounded corners is set to 10bp.

<pre>
\def\printframe #1#2#3#4{\edef\frameslist{\frameslist
    q 1 0 0 1 \bp{\hoffset+10bp} \bp{#2+10bp} cm    % origin shifted to the left-bottom
    \_oval{\bp{\_xhsize-20bp}}{\bp{#4-20bp}}{10} B Q }%
}
</pre>

<p CLASS=datum>(0034) -- P. O., 2021-01-14<p>
<hr>

<p CLASS="lmarg">Macro tricks</p>

<h2><a name="condi"></a>Structured conditionals</h2>

<p>The usage of \if* conditionals is very uncomfortable if we need to
use some structured logical expression in our macros 
with brackets () and logical AND, OR. This is not implemented at 
TeX primitive level, unfortunately. But we can use the following trick:

<pre>
\def\cond[#1:#2]{#1 1\else0\fi}

%%        IF      (           a=a     AND          c=c      ) OR          e=f       then 
\ifnum 0&lt;\numexpr ( \cond[\ifx aa:\fi] * \cond[\ifx cc:\fi] ) + \cond[\ifx ef:\fi] \relax
     YES \else NO \fi
</pre>

<p>The \cond macro has syntax: \cond[primitive conditional:\fi] where
primitive conditional is \ifx, \if, \ifnum, \ifvoid, \ifmmode, \ifdim, etc.
followed by elementary conditional expression which syntax is dependent on
used \if primitive. The \fi prameter is mandatory here because we need to
have the whole construction \if-skipable.

<p>If you want to use AND logical conjunction write *. If you want OR write
+. Use brackets () as usual. The whole \if construction is fully expandable.

<p>You can add another logical operators if you want:

<pre>
\def\IMPL#1{\IMPLa#1\relax}
\def\IMPLa#1=>#2\relax{\ifnum #1>#2 0\else 1\fi} 

\ifnum 0&lt;\numexpr 
%        (         a=a      =>           c=d     ) AND          2=2        then
   \IMPL{ \cond[\if aa:\fi] => \cond[\if cd:\fi] } * \cond[\ifnum2=2:\fi] \relax 
   Yes \else No \fi
</pre>

<p CLASS=datum>(0019) -- P. O. 2020-05-27<p>
<hr>

<h2><a name="setpos"></a>Absolute positions on the page</h2>

<p>You can write \setpos[label] somewhere and the position of such \setpos[label]
can be referenced by \posx[label], \posy[label] and \pospg[label].
The first two macros expand to x and y position measured from left-bottom 
corner of the page (dimen values) and \pospg[label]
expands to the page number in the document (counted from one at beginning of
the document).

<p>These values are available in second (and more) TeX run, because the
information is saved to ref file and restored from it at the beginning of
TeX job. If these vaules are not known then mentioned macros expand to 0sp,
0sp and 0.

<pre>
\refdecl{
   \def\Xpos#1#2#3{\sxdef{pos:#1}{{#2}{#3}\_currpage}}
}
\def\setpos[#1]{\openref\pdfsavepos
   \_ewref\Xpos{{#1}\unexpanded{{\the\pdflastxpos}{\the\pdflastypos}}}}

\def\posx [#1]{\_ea \posi   \romannumeral-`\.\trycs{pos:#1}{{0}{0}{0}{0}}sp}
\def\posy [#1]{\_ea \posii  \romannumeral-`\.\trycs{pos:#1}{{0}{0}{0}{0}}sp}
\def\pospg[#1]{\_ea \posiii \romannumeral-`\.\trycs{pos:#1}{{0}{0}{0}{0}}}

\def\posi   #1#2#3#4{#1}
\def\posii  #1#2#3#4{#2}
\def\posiii #1#2#3#4{#3}
</pre>

<p>The coordinates are saved to the .ref file in the format \Xpos{label}{x-pos}{y-pos}.
The \Xpos macro defines \pos:label as {x-pos}{y-pos}{total-pg}{rel-pg}.
We need to read only given parameter by \posi, \posii or \posiii auxiliary
macros. The \romannumeral-`\. trick does (empty) expansion of \trycs until first {
occurs.

<p>This example shows the usage of \refdecl macro from OpTeX and \pdfsavepos,
\pdflastxpos, \pdflastypos pdfTeX primitives.

<p>Unusable example: the following code draws the line from current position
to the left-bottom corner of the page.

<pre>
Text text\setpos[A]\pdfliteral{q 0 0 m -\bp{\posx[A]} -\bp{\posy[A]} l S Q}
</pre>

<p CLASS=datum>(0020) -- P. O. 2020-05-27<p>
<hr>

<h2><a name="anodes"></a>Drawing to given nodes</h2>

<p>We show the application of the previous <a href="#setpos">OpTeX trick 0020</a>.
We can connect two (or more) points at the single page by a line
(more lines, curves). These points are declared by the position of the current
point. For example the last word of the first paragraph is connected to the
last word of the second paragraph by a line:

<pre>
This is first paragraph.\setorigin\pdfliteral{0 0 m \bpx[end1] \bpy[end1] l S}

This is second paragraph connected by a line.\setpos[end1]
</pre>

<p>One position must be set by \setorigin. Other positions at the
same page can be set by \setpos[label]. Then you can draw something at origin
position by \pdfliteral primitive. The coordinates of the origin is 0,0, the
coordinates of a point with label [label] (in big points) is given by
\bpx[label],\bpy[label].

<p>Use macros from previous <a href="#setpos">OpTeX trick 0020</a>
and these macros:

<pre>
\newcount\posorigin
\def\setorigin{\incr\posorigin\xdef\origin{ori:\the\posorigin}\setpos[ori:\the\posorigin]}
\def\bpx[#1]{\expr{\bp{\posx[#1]}-\bp{\posx[\origin]}}}
\def\bpy[#1]{\expr{\bp{\posy[#1]}-\bp{\posy[\origin]}}}
</pre>

<p>We can add arrows using macro \arrowccspike and \rotcm from
<a href="#carrows">OpTeX trick 0037</a>:

<pre>
This is first paragraph.\setorigin
\pdfliteral{q 0 0 m 1 0 0 RG 1 0 0 rg
   100 40 \expr{\bpx[end1]+50} \expr{\bpy[end1]+30} \bpx[end1] \bpy[end1] c S
   q \rotcm (0 0) (-100 -40) 0 0 cm \arrowccspike\space Q
   q \rotcm (0 0) (-50 -30) \bpx[end1] \bpy[end1] cm \arrowccspike\space Q
   Q}

This is second paragraph connected by a line.\setpos[end1]
</pre>

<p><IMG SRC="../img/sipky2-ukazka.png" ALT="Code blocks" border=0>

<p CLASS=datum>(0041) -- P. O. 2021-02-06<p>
<hr>


<h2><a name="tabs"></a>Tabbing macros</h2>

<p>Plain TeX provides tabbing macros but OpTeX does not, bacuase old typewriter
style for alignment is not preferred. Use \table instead this. 
Or you can set such typewriter TABs by
following macros. Moreower, these macros are more intelligent than the Plain
TeX equivalent.

<p>You can say \settabs 4\column. Then the \hsize is divided to four
equal-size parts, each of them begins by a TAB position and the last one
ends by a TAB position too. I.e. there are five equi-distant TAB positions. 
Then you can type

<pre>
\tabs first text &amp; second text &amp; third text &amp; fourth text &amp; other text \cr
</pre>

<p>The left boundary of the first text is aligned with first TAB position. The
next text is aligned to next TAB position. But it needs not to be exactly the second
one: all TAB positions which are left to the actual text position are
ignored and the first non-ignored TAB position is used. 
This means that the text is never overlapped. This is real behavior 
of old typewriters. Go to a Museum of Technology and try it.
This is the significant difference from plain TeX macros.

<p>You can set the TAB positions by invisible sample line too:

<pre>
\settabs\tabs &amp;textA&amp;textB&amp;textC\cr
</pre>

<p>Each &amp; or \cr gives one TAB position. If you did not use first &amp;
immediately after \tabs then first TAB position is shifted from left
boundary of lines. 

<p>The implementation looks like:

<pre>
\def\tabs #1\cr{\setbox0=\hbox\bgroup \tabA #1&amp;\cr&amp;}
\def\tabA #1&amp;{\ifx\cr#1\egroup\box0 \else 
   \egroup 
      \tmpdim=\maxdimen \ea\tabB \tabsdata {}\relax
      \ifdim \tmpdim=\maxdimen \tmpdim=0pt
      \else \advance\tmpdim by-\wd0 \fi
   \setbox0=\hbox\bgroup \unhbox0 \kern\tmpdim \ignorespaces#1\unskip\kern1sp
   \_ea\tabA \fi
}
\def\tabB #1{\ifx^#1^\else \unless\ifdim \wd0>#1 \tmpdim=#1 \tabC \fi \ea\tabB \fi} 
\def\tabC #1\relax {\fi\fi}

\def\settabs #1{\def\tabsdata{}\ifx\tabs#1\_ea\settabstext \else\_ea\settabscols \fi #1}
\def\settabscols #1\columns{\tmpdim=\hsize \divide\tmpdim by#1\relax
   \fornum 0..#1 \do {\edef\tabsdata{\tabsdata{\the\dimexpr##1\tmpdim\relax}}}}

\def\settabstext #1#2\cr{\setbox0=\hbox\bgroup \settabA #2&amp;\cr&amp;}
\def\settabA #1&amp;{\ifx\cr#1\egroup \edef\tabsdata{\tabsdata{\the\wd0}}\else
    #1\egroup \edef\tabsdata{\tabsdata{\the\wd0}}%
    \setbox0=\hbox\bgroup \unhbox0
    \_ea\settabA \fi
}
\def\tabsdata{}  % default: no tabulators set
</pre>

<p>The \tabsdata macro includes TAB positions in the format {0pt}{100pt}{200pt}.
Of course, you can define directly TAB positions by 
\def\tabsdata{{0cm}{2cm}{4cm}{6cm}{8cm}}, for example.

<p>The \tabs macro opens \setbox0=\hbox\bgroup, sets the appropriate text to it, closes
it, measures \wd0, sets appropriate kern, opens \setbox0=\hbox\bgroup
\unhbox0 again ad does this in a loop.

<p CLASS=datum>(0021) -- P. O. 2020-05-27<p>
<hr>

<h2><a name="vardef"></a>Macro with variable number of arguments in braces</h2>

<p>You can create a macro by \vardef\mymacro{...} which can be used
with arbitrary number of parameters enclosed in braces. For example
\mymacro{first}{second} or \mymacro{one}{two}{three}.
If the \mymacro is declared by \vardef, then you can use
\NARGS in the macro body (this expands to the number of parameters just
read) and \ARG{num} which expands to the num-th parameter.

<p>This code is published at
<a href="https://tex.stackexchange.com/questions/305383#305433">Stack
exchange</a> too. The discussion and more detail description is there.

<pre>
\newcount\vardefnum
\newtoks\vardefinition

\def\vardef#1#2{%
\def#1{%
    \vardefnum=0
    \vardefinition{#2}%
    \grab}}

\def\grab{\futurelet\next\grabA}

\def\grabA{\ifx\next\bgroup \expandafter\storearg \else
  \edef\NARGS{\the\vardefnum}%
  \def\ARG##1{\csname vararg:##1\endcsname}%
  \the\vardefinition
  \let\NARGS\undefined \let\ARG=\undefined
  \fi}

\def\storearg#1{\advance\vardefnum by 1
  \ea\def\csname vararg:\the\vardefnum\endcsname{#1}%
  \grab}
</pre>

<p>The body #2 of a user defined macro is stored in the \vardefinition token
string. Then the opening brace { is tested by the \futurelet primitive and
possible parameters are read to \vararg:num macro. Next, the \vardefinition
is processed.

<p>You can test it by following code:

<pre>
\vardef\mymacro{%
  The number of arguments passed to {\tt\string\mymacro} is \NARGS.
  \ifnum\NARGS=0\else
     They are:
     \tmpnum=1 \loop \ARG{\the\tmpnum}%
        \ifnum\NARGS>\tmpnum, \advance\tmpnum by 1 \repeat.\fi
}

\mymacro{a}{b}{c}

\mymacro{1}{2}{3}{4}{5}

\mymacro{x}

\mymacro{}{}{}{}

\mymacro123  % You can't omit brackets!
</pre>

<p CLASS=datum>(0025) -- Matteo Caoduro. 2020-06-05<p>
<hr>

<h2><a name="import"></a>The import package</h2>

<p>We implement the LaTeX import package (see texdoc import)
by three lines of the code.

<pre>
\def\import#1#2{\def\tmp{\gtoksapp\picdir{#1/}\input{#2}}%
   \ea\tmp\ea\global\ea\picdir\ea{\the\picdir}}
\def\input#1{\_input{\the\picdir#1}}
</pre>

<p>The \input is redefined as primitive input applied to "\the\picdir
filename". The \import macro redeclares \picdir and does the \input. When
input is finished, then \picdir returns to its previous value.

<p>Unlike the import LaTeX package, the \import macro can be used recursively
in imported files. So, we need not to define \subimport.

<p CLASS=datum>(0035) -- P. O., 2021-01-14<p>
<hr>

<h2><a name="num"></a>Numbers printed in three-digits groups</h2>

<p>The long number should be printed with spaces (or another symbol
depending on used language) with three-digits groups. For example:

<pre>
  2 365 121
     10 115.16
         25.145 17
</pre>

<p>We can write \num 2365121 or \num 10115.1 or \num 25.14517 and the
grouping will be calculated by the macro.

<pre>
\def\num#1 {\isinlist{#1}{.}\iftrue \ea\numG \else \ea\numH\fi#1\relax}
\def\numG#1.#2\relax{\numH#1\relax\decimaldot\numC#2\relax\relax\relax\relax\relax}
\def\numH#1\relax{\tmpnum=0 \numA #1\relax \numB#1\relax\relax\relax\relax\relax}
\def\numA#1{\ifx\relax#1\empty \else \incr\tmpnum \ea\numA \fi}
\def\numB{\edef\tmp{\the\tmpnum}\divide\tmpnum by3 \multiply\tmpnum by3
   \ifcase \numexpr\tmp-\tmpnum\relax \ea\numC \or \ea\numD \or \ea\numE\fi}
\def\numC#1#2#3{#1#2#3\ifx\relax#3\empty\else\ea\numF\fi}
\def\numD#1{#1\numF}
\def\numE#1#2{#1#2\numF}
\def\numF#1#2#3{\ifx\relax#1\empty \else \numsep #1#2#3\ea\numF\fi}
\def\numsep{\,}
\def\decimaldot{.}
</pre>

<p>The macro \num reads the number separated by space. If it incudes period
then the front part is processed by \numH and the decimal part by \numC.
The front part is processed in two steps. First, the macro counts the number of
digits by \numA and then it inserts spaces by \numB,...\numF.

<p>We can use this macro in tables with Nn declarator
(see <a href="#dnaligned">OpTeX trick 0039</a>), but we must add the &amp;
symbol at the end of the \numH macro:

<pre>
\def\numH#1\relax{\tmpnum=0 \numA #1\relax \numB#1\relax\relax\relax\relax\relax&amp;}

\def\_tabdeclareN{\the\tabiteml \hfil \num ##\_unsskip}
\def\_tabdeclaren{##\_unsskip\hfil\the\tabitemr}

\table{|c|Nn|}{\crl
   first:   &amp; 23433.1       \cr
   second:  &amp;    55.131415  \crl
}
</pre>

<p CLASS=datum>(0040) -- P. O., 2021-02-06<p>
<hr>

<h2><a name="scantok"></a>Expandable token-per-token scanner</h2>

<p>We define \def\dotoken#1{do something with #1} and we can use
\scantokenlist{token list}. The macro \scantokenlist calls \dotoken
repeatedly to each token from the given token list. All tokens are prepared
"as is" in the #1 parameter (including category code), only { and } are
given as tokens with the same ASCI code but category 12.

<p>The implementation follows:

<pre>
\def\scantokenlist #1{%
   \immediateassignment\edef\tmp{\scantokenlistA #1{\final_token} }%
   \immediateassignment\edef\tmp{\ea\scantokenlistC \tmp \final_token}%
   \ea\scantokenlistD\tmp \final_token
}
\def\scantokenlistA #1#{\unexpanded{#1}\scantokenlistB}
\def\scantokenlistB #1{\ifx\final_token#1\empty\else
   \string{\scantokenlistA#1{\final_token}\string}\ea\scantokenlistA\fi}
\def\scantokenlistC #1 #2{\ifx\final_token#2\empty\unexpanded{#1}\else
   \unexpanded{#1{ }#2}\ea\scantokenlistC\fi}
\def\scantokenlistD #1{\ifx\final_token#1\else \dotoken{#1}\ea\scantokenlistD\fi}
\def\final_token{\final\stop\mark}

%% Test:
\def\dotoken#1{^^Jtoken: \string#1}
\message{\scantokenlist{a{h}#a {\test u{f}f muf}f.}}
</pre>

<p>First, \scantokenlistA converts { and } to category 12. It is used in \edef
with \immediateassignment which makes \edef expandable. This is LuaTeX feature.
Second, \scantokenlistC converts spaces to spaces surrounded in { }.
Third, \scantokenlistD applies \dotoken to each token in the preprocessed
token list.

<p>If you want to return converted token list to the the original
token list ({,} have catcodes 1,2) then you can define

<pre>
\def\dotoken#1{\ea\ifx\string{#1{\else\ea\ifx\string}#1}\else\noexpand#1\fi\fi}
</pre>

<p>and run \scantokenlist in \edef, for example

<pre>
\edef\mylist{\ea\scantokenlist\ea{\mylist}}
</pre>

<p CLASS=datum>(0042) -- P. O., 2021-02-06<p>
<hr>

<h2><a name="balancing"></a>Nested brackets of another type than {}</h2>

<p>TeX checks the nested brackets only for one type of brackets: {}. OpTeX
uses macros sometimes with the parameters surrounded by [] brackets, but
they cannot be simply nested. If you write (for example) \label[a[b]c] then
you get the label a[b and the text c] is printed. You can check the pairs
and nesting of another type of brackets than {} by the \ensurebalanced
macro:

<pre>
% \ensurebalanced left-bracket right-bracket macro-to-run {first-attempt}
\def\macro[#1]{\ensurebalanced[]\macroA{#1}}
\def\macroA#1{the parameter "#1" has balanced brackets [].}
for example:
\macro[a[b]c] prints: the parameter "a[b]c" has balanced brackets [].
</pre>

<p>The \label macro can be redefined in order to balanced [] brackets can be nested:

<pre>
\def\tmp{\def\labelA##1}\ea\tmp\ea{\label[#1]}
\def\label[#1]{\ensurebalanced[]\labelA{#1}}
</pre>

<p>The \ensurebalanced macro is defined by:

<pre>
\def\ensurebalanced#1#2#3{\immediateassigned{%
   \def\balopen{#1}\def\balclose{#2}\let\balaction=#3%
   \def\readnextbal##1##2#2{\ensurebalancedA{##1#2##2}}}%
   \ensurebalancedA}
\def\ensurebalancedA#1{\isbalanced#1%
   \iftrue\afterfi{\balaction{#1}}\else\afterfi{\readnextbal{#1}}\fi}
\def\isbalanced#1\iftrue{\immediateassignment\tmpnum=0 \isbalancedA#1{\isbalanced}}
\def\isbalancedA#1#{\countbalanced#1\isbalanced \isbalancedB}
\def\isbalancedB#1{%
   \ifx\isbalanced#1\afterfi{\cs{ifnum}\tmpnum=0 }\else\ea\isbalancedA\fi}
\def\countbalanced#1{\ea\ifx\balopen #1\immediateassignment\incr\tmpnum\fi
                     \ea\ifx\balclose#1\immediateassignment\decr\tmpnum\fi
                     \ifx\isbalanced#1\else\ea\countbalanced\fi}
</pre>

<p>The macro \ensurebalanced is fully expandable using LuaTeX
primitives \immediateassigned and \immediateassignment.

<p>If the parameter includes {...} then balancing is not counted inside this
pair. It. means that balancing of {...} has higher priority.

<p>The heart of this macro is \ensurebalancedA and \readnextbal. They say
(roughly speaking):

<pre>
\ensurebalancedA #1 -> \isbalanced #1\iftrue \balaction{#1}\else \readnextbal{#1}
\readnextbal #1#2] -> \ensurebalancedA{#1]#2}
</pre>

<p>The \readnextbal reads next part of the text until next ] occurs.

<p CLASS=datum>(0043) -- P. O., 2021-02-06<p>
<hr>

<p CLASS="lmarg">Sections</p>

<h2><a name="seccc"></a>New level o sections</h2>

<p>OpTeX defines \chap, \sec and \secc. A new level \seccc is not defined, but
we can do it as an exercise of sections programming in OpTeX.
The \chap ahs level 1, \sec has level 2, \secc has level 3. So, we will
declare the 4th level of sections.

<p>Note that OpTeX declares \secl4, \secl5, etc. but all these levels of
sections are unnumbered, without copying to table of contents and with an only
very simple design.

<p>We can define \seccc analogical like \secc already defined in OpTeX:

<pre>
\newcount \_secccnum
\def \_thesecccnum {\_othe\_chapnum.\_the\_secnum.\_the\_seccnum.\_the\_secccnum}

\_optdef\_seccc[]{\_trylabel \_scantoeol\_inseccc}

\_def\_inseccc #1{\_par \_sectionlevel=4
   \_def \_savedtitle {#1}% saved to .ref file
   \_ifnonum \_else {\_globaldefs=1 \_incr\_secccnum \_secccx}\_fi
   \_edef \_therefnum {\_ifnonum \_space \_else \_thesecccnum \_fi}%
   \_printseccc{\_scantextokens{#1}}%
   \_resetnonumnotoc
}
\public \seccc ;
</pre>

<p>We must implement resetting new counter at \secc level. All concept of
reseting counters are copied here for greater clarity.

<pre>
\_def \_chapx {\_secx   \_secnum=0   \_lfnotenum=0 }
\_def \_secx  {\_seccx  \_seccnum=0  \_tnum=0 \_fnum=0 \_dnum=0 \_resetABCDE }
\_def \_seccx {\_secccx \_secccnum=0 }
\_def \_secccx {}
</pre>

<p>Finally, we must declare a design of the \seccc:

<pre>
\_def\_printseccc#1{\_par
   \_abovetitle{\_penalty-100}{\_medskip}
   {\_bf \_noindent \_raggedright \_printrefnum[@\_quad]#1\_nbpar}%
   \_nobreak \_belowtitle{\_smallskip}%
   \_firstnoindent
}
</pre>

<p>If we want to see \seccc in the table of contents, then we must declare the
printing rule of the 4th level of sections:

<pre>
\_sdef{_tocl:4}#1#2#3{\_advance\_leftskip by2\_iindent \_cs{_tocl:2}{#1}{#2}{#3}}
</pre>

<p>Now, \seccc works in the table of contents and in PDF outlines too:

<pre>
\hyperlinks \Green \Green
\outlines0

\maketoc

\chap  My chapter
\sec   Special section
\secc  This is subsection
\seccc New level of sub-subsection
Text.
\seccc Next text
Text.

\end
</pre>

<p CLASS=datum>(0033) -- P. O., 2021-01-14<p>
<hr>

<p CLASS="lmarg">Slides</p>

<h2><a name="slider"></a>Navigation bar for selecting pages</h2>

<p>The following code creates a clickable navigation bar for selecting
pages/slides in \slides style. You can insert it to the file
<tt>op-slides.tex</tt> (between lines \backgroundpic{op-slides-bg.png}
and \activettchar` and try it. You must process the document by OpTeX twice.

<pre>
\pgbackground={\vbox to0pt{\_copy\_bgbox\_vss}
     \ifnum\_slidelayer=0 \_slidelayer=1 \fi
     \ifnum\pageno>\thispage
        \xdef\thispage{\the\pageno}\xdef\maxlayer{\_cs{_p:\thispage}}\fi
     \immediate\_wref\_sdef{{_p:\_the\_pageno}{\_the\_slidelayer}}
     \_sxdef{_p:\_the\_pageno}{\_the\_slidelayer}
     \nointerlineskip
     \hbox to\pdfpagewidth{\hss\vbox{\null\slideslist}\kern5pt}
}
\def\prepslidepages{\openref\def\slideslist{}%
  \if?\lastpage \else
     \tmpnum=0
     \fornum 1..\lastpage \do{%
         \advance\tmpnum by0\_cs{_p:##1}\edef\tmp{\the\tmpnum}%
         \addto\slideslist{\slidepage{##1}}%
         \ea\addto\ea\slideslist\ea{\ea{\tmp}}%
         }%
  \fi
}
\def\thispage{0}
\prepslidepages

\def\slidepage#1#2{%
  \hbox{\Grey \ifnum\pageno=#1 \printpagenum \Blue \fi \pagerectangle{#2}}
}
\def\printpagenum{%
  \llap{\bf\the\pageno \ifnum\_slidelayer=0\maxlayer\else+\fi\ }%
}
\def\pagerectangle#1{\let\Blue=\relax \ilink[pg:#1]{\vrule height.8ex width.8ex}}%

\def\_endslides{\vfil\break \_decr\pageno \edef\lastpage{\folio}
   \let\slideslistA=\slideslist \prepslidepages
   \ifx\slideslistA\slideslist \else \advance \_unresolvedrefs by1 \fi
   \_byehook \_end
}
</pre>

<p> The \pgbackground iserts a background picture declared by
\backgroundpic, then it writes to the .ref file

<pre>
\sdef{_p:pageno}{slidelayer}
</pre>

<p>so, we have saved the number of last layer of each page after the .ref file
is read again. Finally, \pgbackgroud prints the clickable bar as a \vbox
with list of \hbox'es generated by \slideslist macro. This macro is prepared by
\prepslidepages as a list of \slidepage{pageno}{globalpage}. The globalpage
represents the given page with maximal layer and it is used as clickabe link
to the page.

<p>The \_endslides is redefined. It does checking of consistency of the
navigation bar: The \slideslit is created again and compared with previous
\slideslistA. If they are differ then \_unresovedrefs are advanced by 1
and \_byehook will write the "WARNING: Rerun to get references right".
(You need the version of OpTeX bigger than 0.17, where \_endslides
macro is used).

<p CLASS=datum>(0029) -- P. O., 2020-11-19<p>
<hr>


<p CLASS="lmarg">Languages</p>

<h2><a name="ngerman"></a>The (n)german.sty implementation</h2>

<p>Old TeX german documents use shorthands with active " character for

<ul>
<li>dieresis: "a is ä, "U is Ü, etc.
    (comes from old days where ancient 7bit fonts were used),
<li>double es: "s is ß, "S is SS, "z is ẞ, etc.,
<li>quoutation marks: "`text"' is „text“,
<li>special hyphenations: Zu"cker is Zucker or Zuk-/ker,
    Ro"ller is Roller or Roll-/ler,
<li>special marks for hyphenations: "-, "|, "", "~ and "=.
</ul>

<p>See `texdoc ngerman` for more information.

<p>The first three types seem to be obsolette today (but maybe you want to
process an old TeX document or you have an unconfigured keyboard).
The last two types can be usable. You can do
this markup with following definitions:

<pre>
\def\germanTeX   {\deolang \activeqq} % starts old German hyphens 1901 + "shorthands
\def\ngermanTeX  {\delang  \activeqq} % starts new German hyphens 1996 + "shorthands
\def\originalTeX {\enlang  \catcode`"=12 } % English hyphens + deactivates "shorthands

\def\activeqq{\adef"##1{\ifcsname qq:"\string##1\endcsname \cs{qq:"\string##1\_ea}\else
                        \opwarning{"\string##1 not declared}\string##1\fi}}
\def\qqdef"#1{\sdef{qq:"\string#1}}
\qqdef "a{ä} \qqdef "o{ö} \qqdef "u{ü} \qqdef "s{ß}  \qqdef "z{ẞ}  \qqdef "e{ë} \qqdef "i{ï}
\qqdef "A{Ä} \qqdef "O{Ö} \qqdef "U{Ü} \qqdef "S{SS} \qqdef "Z{SZ} \qqdef "E{Ë} \qqdef "I{Ï}

\qqdef "ck{\nobreak\discretionary{k-}{}{c}\allowhyphens k}
\qqdef "CK{\nobreak\discretionary{K-}{}{C}\allowhyphens K}
\qqdef "ll{\specdiscr l} \qqdef "mm{\specdiscr m} \qqdef "nn{\specdiscr n}
\qqdef "LL{\specdiscr L} \qqdef "MM{\specdiscr M} \qqdef "NN{\specdiscr N}
\qqdef "pp{\specdiscr p} \qqdef "rr{\specdiscr r} \qqdef "tt{\specdiscr t}
\qqdef "PP{\specdiscr P} \qqdef "RR{\specdiscr R} \qqdef "TT{\specdiscr T}
\qqdef "ff{\specdiscr f}
\qqdef "FF{\specdiscr F}
\qqdef "`{„} \qqdef "'{“} \qqdef "&lt;{«} \qqdef ">{»}

\qqdef "-{\nobreak\-\allowhyphens}
\qqdef "|{\nobreak\discretionary{-}{}{\kern.03em}\allowhyphens}
\qqdef ""{\hskip0pt\relax}
\qqdef "~{\leavevmode\hbox{-}}
\qqdef "={\nobreak-\hskip0pt\relax}

\def\specdiscr#1{\nobreak\discretionary{#1#1-}{}{#1}\allowhyphens#1}
\def\allowhyphens{\nobreak \hskip0pt\relax}
</pre>

<p>The German environment is opened by
\germanTeX or \ngermanTeX (as described in german.sty and ngerman.sty doc).
You have to load Unicode font (\fontfam[lmfonts], for example)
because preloaded EC fonts have bad encoding for ß, for example. Now, you
can try (text from gerdoc.tex):

<pre>
\fontfam[lmfonts]
\ngermanTeX

Der beim 6.~Treffen der deutschen \TeX-Interessenten in M"unster
festgelegte Befehlssatz wurde nach"-tr"aglich um einige Befehle
erweitert.
\bye
</pre>

<p>Note that usage of these macros are incompatible with \dequotes, i.e. with
quotation marks used by \"text" and preferred in OpTeX.

<p CLASS=datum>(0036) -- P. O., 2021-01-22<p>
<hr>


<p CLASS="lmarg">Others</p>

<h2><a name="version"></a>Version number of the format</h2>

<p>The \optexversion macro expands to "x.yz Mon.Year" or "x.yz+ Mon.Year".
The first one means official released version (uploaded to the CTAN) and the
second one denotes versions of the format patched and uploaded to github.com
but not released. When I decide to release next version, I add one to the minor
number yz, upgrade the date information Mon.Year and remove the + mark. When
I do first new commit to the released version, I add the + mark at
github.com. Next commits do not change \optexversion.

<p>We create an expandable macro \numversion which expands to xyz0 for
released versions and xyz5 for patched versions. You can use it in the context
\ifnum\numversion>number do something\else do something else\fi.

<pre>
\def\numversion{\ea\numversionA\optexversion\relax}
\def\numversionA#1.#2#3#4#5\relax{#1#2#3\ifx+#45\else0\fi}
</pre>

<p CLASS=datum>(0049) -- P. O., 2021-03-02<p>
<hr>

<h2><a name="diff"></a>Showing differences between versions of the document</h2>

<p>If we have two versions of the same document: document-old.tex and
document-new.tex, then we can print document-new.tex with colorized parts of
the text, which is new in this new verison of the document. Define:

<pre>
\def\diffstart/{{\nolocalcolor\Red}}
\def\diffstop/{{\nolocalcolor\Black}}

\regmacro {\def\diffstart/{}\def\diffstop{}} 
          {\def\diffstart/{}\def\diffstop{}}  
          {\def\diffstart/{}\def\diffstop{}}
</pre>

<p>and run

<pre>
wdiff -1 --start-insert='\diffstart/' --end-insert='\diffstop/' \
      document-old.tex document-new.tex > diff.tex
optex diff.tex
</pre>

<p>The resulting PDF have the new phrases in red color. 

<p>Because we are using \localcolor by default and we set these two
colors as \nolocalcolor, then there can be little problems. But most cases are
solved good. Moreover, it is simple and effective.

<p>Only new texts are highigted without any change of formatting the
document. If you need to see colored deleted texts, then you can show it 
on the ANSI terminal:

<pre>
wdiff -n -w $'\033[30;41m' -x $'\033[0m' -y $'\033[30;42m' -z $'\033[0m' \
      document-old.tex document-new.tex | less -R
</pre>

<p>This trick was inspired from an idea by Daniel Gromada. 
He suggested it for the OPmac tricks set.

<p CLASS=datum>(0014) -- P. O., D. G. 2020-05-17<p>
<hr>

<h2><a name="overleaf"></a>How to run OpTeX at Overleaf</h2>

<p>Overleaf is LaTeX oriented site, but we can run most recent OpTeX version
here if we do a set of obscure and dirty tricks.

<p>First of all, we have to generate optex.fmt binary file at Overleaf. This
file is typically binary incompatible in various computers and various
versions of LuaTeX, so you cannot generate it at your computer and
simply upload it. Create a zip file with optex files in your computer:

<pre>
cd ??where optex/ directory is
zip -r optex-recent.zip optex/
</pre>

<p>Create a new Overleaf project and upload optex-recent.zip. Create the
main.tex file with the following contents:

<pre>
\documentclass[a4paper]{article}
\usepackage{bashful}

\begin{document}

\bash[script,stdout,stderr]
unzip -o optex-recent.zip
cd optex/base/
luatex -ini optex.ini
rm *.opm
\END

\end{document}
</pre>

<p>Click "Recompile". The oputput PDF should show the messages from OpTeX
format generation. Click on the icon just right to "Recompile" (logs and
output files), scroll the window down and click on the button "Other logs
&amp; files". The <b>optex.fmt</b> should be here.

<p>The "Other logs &amp; files" are temporary files: Unfortunately, they are
removed before each TeX run. So, you need to download optex.fmt to your
computer and upload again to the Overleaf project. Do it now.

<p>The same is true for unzipped files from optex-recent.zip. They are lost
in the next TeX run. This is reason why we cannot use files from
optex-recent.zip when processing OpTeX documents and we must to 
upload all *.opm files to the Overleaf project <b>again</b>.
Create the subdirectory <b>optex/</b> (lowercase letters) in the project and upload all
*.opm files to this directory. The uploader accepts maximum 40 files per one
upload action, so more than 80 files from OpTeX package need to be uploaded
in three steps. The directory structure in the optex/ directory can be
arbitrary, for example all *.opm files are directly in the optex/ directory.
Alternative: you can upload not all *.opm files but only these files needed
at OpTeX runtime: f-*.opm, hisyntax-*.opm, mathclass.opm, unimath-codes.opm,
unimath-table.opm, usebib.opm, bib-*.opm, slides.opm.

<p>Prepare the <b>latexmkrc</b> at main level of directories in the Overleaf
project with the one-line content:

<pre>
$lualatex = 'TEXINPUTS=./optex//:$TEXINPUTS luatex -fmt=optex %O %S';
</pre>

<p>Upload all files from OpTeX demo/ directory to the main directory level
of Overleaf project, especially op-demo.tex and op-ring.png files. This is only
for testing.

<p>Select from main Overleaf menu: Compiler: LuaLaTeX, main document:
op-demo.tex, Code check: Off. 

<p>Now, you have optex.fmt, latexmkrc, op-demo.tex, op-ring.png in the main
directory. Try the buttom "Recompile" and wait a while 
(LuaTeX needs to initialize the OTF font databases when it runs first). If 
you see the PDF result: "Demonstration", congratulations! The
first run gives the result without TOC, second "Recompile" gives TOC too.

<p>If you have additional OpenType fonts not installed at OverLeaf, then you
can save them into fonts/ directory in your project and modify the
<b>latexmkrc</b> file:

<pre>
$lualatex = 'TEXINPUTS=./optex//:$TEXINPUTS OPENTYPEFONTS=./fonts// luatex -fmt=optex %O %S';
</pre>

<p CLASS=datum>(0022) -- P. O. 2020-05-29<p>
<hr>


</td></tr>
</table>

</BODY></HTML>
